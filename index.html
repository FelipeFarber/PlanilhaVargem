<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Organizacional</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@700;800&display=swap"
        rel="stylesheet">
    <!-- XLSX Library CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Flatpickr Date Picker CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr Portuguese Locale -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style id="print-styles"></style>

    <style>
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #d1d5db; /* Light gray text */
            line-height: 1.6;
        }

        h1.main-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            color: #93c5fd; /* Light blue */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        #loading-screen,
        #section-loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111827;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.hidden,
        #section-loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #section-loading-screen {
            z-index: 9998;
            opacity: 0;
        }

        #section-loading-screen.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .pulsing-image {
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        .file-input::-webkit-file-upload-button {
            margin-right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 0;
            font-size: 0.875rem;
            font-weight: 600;
            background-color: #374151;
            color: #d1d5db;
            cursor: pointer;
        }

        .file-input:hover::-webkit-file-upload-button {
            background-color: #4b5563;
        }

        .data-table .day-cell,
        .data-table .editable-text-cell,
        .editable-event {
            cursor: pointer;
        }

        .editable-event:hover {
            background-color: #374151;
            border-radius: 4px;
        }

        .data-table .day-cell {
            text-align: center;
        }

        .data-table thead th {
            background-color: #1e40af;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-table tbody tr.main-row {
            background-color: #1f2937;
            border-bottom: 1px solid #374151;
        }
        
        .data-table tbody tr.main-row:hover {
             background-color: #374151;
        }


        .schedule-table thead th {
            background-color: #1e40af;
            color: white;
            font-weight: 600;
        }

        .schedule-table .sabado-day {
            background-color: #422006;
        }

        .schedule-table .domingo-day {
            background-color: #450a0a;
        }

        .schedule-table .editable-team-member {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: inline-block;
            padding: 2px 4px;
            border-radius: 4px;
            margin-bottom: 2px;
        }

        .schedule-table .editable-team-member:hover {
            background-color: #3b82f6;
        }

        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #374151;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #d1d5db;
            margin-bottom: 1rem;
            transition: background-color 0.3s ease-in-out;
        }

        .collapsible-header:hover {
            background-color: #4b5563;
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            max-height: 1000px; /* Adjust as needed */
        }

        .collapsible-content.hidden {
            max-height: 0;
            opacity: 0;
        }
        
        #dataTableContent {
            max-height: 60vh;
            overflow-y: auto;
        }

        #custom-confirm-modal,
        #summary-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #custom-confirm-modal.visible,
        #summary-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: #1f2937;
            color: #d1d5db;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%;
            width: 700px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        
        #summary-modal.visible .modal-content {
            transform: scale(1);
        }

        .event-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
        }

        .event-tab.active {
            border-color: #60a5fa;
            color: #93c5fd;
            font-weight: 600;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media print {
            body {
                background-color: #fff !important;
                font-size: 10pt;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            main {
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            h1.main-title {
                display: none !important;
            }

            .no-print {
                display: none !important;
            }

            .content-section {
                display: none !important;
            }
            
            body.printing-info #info-section,
            body.printing-schedule #schedule-section,
            body.printing-occurrences #occurrences-section,
            body.printing-events #events-section {
                display: block !important;
            }

            .p-6.bg-white {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }

            h2,
            h3 {
                text-align: center;
                color: #000;
                text-shadow: none;
                margin-bottom: 1rem;
            }
            
            #data-container .data-table { display: none; }
            #data-container .print-only-table { display: table !important; width: 100%; border-collapse: collapse; }
            #data-container .print-only-table th,
            #data-container .print-only-table td {
                border: 1px solid #ccc;
                padding: 6px;
                text-align: left;
            }
            #data-container .print-only-table th {
                background-color: #e5e7eb !important;
                color: #000;
            }

            body.printing-schedule #schedule-output .no-print-view {
                display: block !important;
            }
            body.printing-schedule .grid {
                display: grid !important;
            }
            body.printing-schedule .grid-cols-7 {
                grid-template-columns: repeat(7, minmax(0, 1fr));
            }
            body.printing-schedule .gap-2 {
                gap: 0.25rem;
            }
            body.printing-schedule .rounded-lg {
                border-radius: 0.25rem !important;
                border: 1px solid #ccc !important;
            }
            body.printing-schedule .min-h-\[110px\] {
                min-height: 0 !important;
                height: 14vh; 
            }
             body.printing-schedule .text-xs {
                font-size: 7pt !important;
                line-height: 1.2;
             }
             body.printing-schedule .font-bold {
                font-size: 8pt !important;
             }
             body.printing-schedule .p-2 {
                padding: 0.25rem !important;
             }
             body.printing-schedule svg {
                display: none;
             }
             body.printing-schedule .assignment-group strong {
                margin-bottom: 2px;
             }
             body.printing-schedule .truncate {
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
            }

            #occurrences-list > div,
            #circuit-events-list > div,
            #bethel-events-list > div {
                border: 1px solid #ccc;
                box-shadow: none;
                page-break-inside: avoid;
                margin-bottom: 1rem;
            }
            
            #occurrences-list img { display: none; }
            
            .alert-print {
                background-color: #fef9c3 !important;
                border-left: 4px solid #facc15 !important;
            }
        }
    </style>
</head>

<body class="group">
    <div id="loading-screen"><img src="images/logo.png" alt="Carregando..." class="pulsing-image w-32 h-32"></div>
    <div id="section-loading-screen" class="hidden"><img src="images/logo.png" alt="Carregando Seção..."
            class="pulsing-image w-32 h-32"></div>
    <div id="custom-confirm-modal">
        <div class="modal-content">
            <p id="confirm-modal-text" class="mb-6 text-lg text-gray-300"></p>
            <div class="flex justify-center gap-4"><button id="confirm-modal-yes"
                    class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">Sim</button><button
                    id="confirm-modal-no"
                    class="px-6 py-2 bg-gray-500 text-gray-100 font-semibold rounded-lg shadow-md hover:bg-gray-600">Não</button>
            </div>
        </div>
    </div>

    <div id="summary-modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-blue-300 mb-4 text-center">Resumo de Eventos</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div class="text-left space-y-4">
                    <div>
                        <h4 class="font-bold text-gray-300 mb-2 border-b border-gray-600 pb-1">Sup. de Circuito</h4>
                        <p><span class="font-semibold">Pub. Estimados:</span> <span id="summary-publishers-circuit" class="font-bold text-blue-400"></span></p>
                        <p><span class="font-semibold">Assist. Estimada:</span> <span id="summary-attendance-circuit" class="font-bold text-blue-400"></span></p>
                        <p><span class="font-semibold">Fins de Semana:</span> <span id="summary-weekends-circuit" class="font-bold text-blue-400"></span></p>
                        <p><span class="font-semibold">Circuitos:</span> <span id="summary-circuits-circuit" class="font-bold text-blue-400"></span></p>
                        <p><span class="font-semibold">Congregações:</span> <span id="summary-congregations-circuit" class="font-bold text-blue-400"></span></p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-300 mb-2 border-b border-gray-600 pb-1">Rep. de Betel</h4>
                        <p><span class="font-semibold">Pub. Estimados:</span> <span id="summary-publishers-bethel" class="font-bold text-green-400"></span></p>
                        <p><span class="font-semibold">Assist. Estimada:</span> <span id="summary-attendance-bethel" class="font-bold text-green-400"></span></p>
                        <p><span class="font-semibold">Fins de Semana:</span> <span id="summary-weekends-bethel" class="font-bold text-green-400"></span></p>
                        <p><span class="font-semibold">Circuitos:</span> <span id="summary-circuits-bethel" class="font-bold text-green-400"></span></p>
                        <p><span class="font-semibold">Congregações:</span> <span id="summary-congregations-bethel" class="font-bold text-green-400"></span></p>
                    </div>
                     <div>
                        <h4 class="font-bold text-gray-300 mb-2 border-b-2 border-gray-500 pb-1">Total Geral</h4>
                        <p><span class="font-semibold">Pub. Estimados:</span> <span id="summary-publishers-total" class="font-bold text-gray-100"></span></p>
                        <p><span class="font-semibold">Assist. Estimada:</span> <span id="summary-attendance-total" class="font-bold text-gray-100"></span></p>
                        <p><span class="font-semibold">Fins de Semana:</span> <span id="summary-weekends-total" class="font-bold text-gray-100"></span></p>
                        <p><span class="font-semibold">Circuitos:</span> <span id="summary-circuits-total" class="font-bold text-gray-100"></span></p>
                        <p><span class="font-semibold">Congregações:</span> <span id="summary-congregations-total" class="font-bold text-gray-100"></span></p>
                    </div>
                </div>
                <div class="mt-4">
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>
            <div class="flex justify-center mt-8">
                <button id="summary-modal-close" class="px-8 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Fechar</button>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>
    <nav id="navbar"
        class="fixed top-0 left-0 h-full w-60 bg-gray-900 text-gray-300 shadow-xl z-30 flex flex-col items-center py-8 no-print transform -translate-x-full group-[.menu-open]:translate-x-0 transition-transform duration-300 ease-in-out">
        <div class="mb-10"><img src="images/logo.png" alt="Logo" class="h-20 w-auto"></div>
        <div class="flex flex-col space-y-3 w-full px-4">
            <a href="#info-section" id="nav-info"
                class="flex items-center justify-start text-lg font-semibold hover:bg-gray-700 p-3 rounded-lg transition-colors">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Informações
            </a>
            <a href="#schedule-section" id="nav-schedule"
                class="flex items-center justify-start text-lg font-semibold hover:bg-gray-700 p-3 rounded-lg transition-colors">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Escala
            </a>
            <a href="#occurrences-section" id="nav-occurrences"
                class="flex items-center justify-start text-lg font-semibold hover:bg-gray-700 p-3 rounded-lg transition-colors">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                Ocorrências
            </a>
            <a href="#events-section" id="nav-events"
                class="flex items-center justify-start text-lg font-semibold hover:bg-gray-700 p-3 rounded-lg transition-colors">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Eventos
            </a>
        </div>
    </nav>
    <button id="menu-toggle"
        class="fixed top-4 left-4 z-40 p-2 bg-gray-800 text-white rounded-md hover:bg-gray-700 transition-all duration-300 ease-in-out no-print lg:group-[.menu-open]:left-64"><svg
            id="menu-open-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg><svg id="menu-close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg></button>

    <main id="main-content"
        class="p-4 sm:p-6 lg:p-8 transition-all duration-300 ease-in-out lg:group-[.menu-open]:ml-60">
        <div class="max-w-7xl mx-auto">
            <h1 id="main-title" class="main-title text-4xl sm:text-5xl font-extrabold mb-8 text-center">Gerenciador
                Organizacional</h1>

            <div id="info-section" class="content-section hidden">
                <div class="mb-8 p-6 bg-gray-800 rounded-lg shadow-md no-print">
                    <div class="flex flex-col items-center gap-4"><input type="file" id="excelFile" accept=".xlsx, .xls"
                            class="file-input block w-full max-w-sm text-sm text-gray-300 border border-gray-600 rounded-lg cursor-pointer bg-gray-700 focus:outline-none">
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 w-full"><button id="loadExcel"
                                class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 w-full">Carregar
                                Planilha</button><button id="saveData"
                                class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 w-full">Salvar
                                Dados</button><button id="loadData"
                                class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 w-full">Carregar
                                Dados</button><button id="exportExcel"
                                class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 w-full">Exportar
                                p/ Excel</button><button id="deleteSelectedBtn"
                                class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 w-full">Excluir</button><button
                                id="clearAllDataBtn"
                                class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 w-full">Limpar
                                Tudo</button></div>
                    </div>
                </div>
                <div class="mb-8">
                    <div id="addPersonFormToggle" class="collapsible-header no-print">
                        <span>Adicionar Novo Publicador</span>
                        <span id="addPersonToggleIcon">►</span>
                    </div>
                    <div id="addPersonFormContent" class="collapsible-content hidden">
                        <div class="p-6 bg-gray-800 rounded-lg shadow-md no-print">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"><input type="text"
                                    id="newName" placeholder="Nome Completo"
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><select
                                    id="newMeetingDayWeekday"
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Reunião Meio de Semana</option>
                                    <option value="segunda">Segunda-feira</option>
                                    <option value="terca">Terça-feira</option>
                                    <option value="quarta">Quarta-feira</option>
                                    <option value="quinta">Quinta-feira</option>
                                    <option value="sexta">Sexta-feira</option>
                                </select><select id="newMeetingDayWeekend"
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Reunião Fim de Semana</option>
                                    <option value="sabado">Sábado</option>
                                    <option value="domingo">Domingo</option>
                                    <option value="final de semana">Fim de Semana (Ambos)</option>
                                </select></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div><label for="newStatus"
                                        class="block text-sm font-medium text-gray-400">Status</label><select id="newStatus"
                                        class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md w-full">
                                        <option value="Solteiro(a)">Solteiro(a)</option>
                                        <option value="Casal">Casal</option>
                                    </select></div>
                                <div id="main-person-gender-container"><label for="newGender"
                                        class="block text-sm font-medium text-gray-400">Gênero</label><select id="newGender"
                                        class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md w-full">
                                        <option value="Feminino">Feminino</option>
                                        <option value="Masculino">Masculino</option>
                                    </select></div>
                            </div>
                            <div id="couple-container" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div><label for="newSpouseName" class="block text-sm font-medium text-gray-400">Nome do
                                        Cônjuge</label><input type="text" id="newSpouseName" placeholder="Nome do Cônjuge"
                                        class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md w-full"></div>
                                <div id="spouse-gender-container"><label for="newSpouseGender"
                                        class="block text-sm font-medium text-gray-400">Gênero do Cônjuge</label><select
                                        id="newSpouseGender" class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md w-full">
                                        <option value="Masculino">Masculino</option>
                                        <option value="Feminino">Feminino</option>
                                    </select></div>
                            </div>
                            <div class="mb-4"><label class="block text-sm font-medium text-gray-400 mb-1">Dias de Assembleia ou
                                    Congresso:</label><input type="text" id="newCongressDates"
                                    placeholder="Clique para selecionar o início e o fim..." readonly
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md w-full cursor-pointer"></div>
                            <div class="flex flex-wrap gap-4 mb-4"><label class="flex items-center space-x-2"><input
                                        type="checkbox" id="newSeg" class="form-checkbox" checked><span>Seg</span></label><label
                                    class="flex items-center space-x-2"><input type="checkbox" id="newTer" class="form-checkbox"
                                        checked><span>Ter</span></label><label class="flex items-center space-x-2"><input
                                        type="checkbox" id="newQua" class="form-checkbox" checked><span>Qua</span></label><label
                                    class="flex items-center space-x-2"><input type="checkbox" id="newQui" class="form-checkbox"
                                        checked><span>Qui</span></label><label class="flex items-center space-x-2"><input
                                        type="checkbox" id="newSex" class="form-checkbox" checked><span>Sex</span></label><label
                                    class="flex items-center space-x-2"><input type="checkbox" id="newSab" class="form-checkbox"
                                        checked><span>Sab</span></label><label class="flex items-center space-x-2"><input
                                        type="checkbox" id="newDom" class="form-checkbox" checked><span>Dom</span></label></div>
                            <button id="addPersonBtn"
                                class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 w-full transform hover:scale-105">Adicionar
                                Publicador</button>
                        </div>
                    </div>
                </div>
                <div id="message-box" class="hidden p-4 mb-4 text-sm text-center rounded-lg no-print" role="alert">
                </div>
                <div class="mb-8">
                    <div id="dataTableToggle" class="collapsible-header no-print"><span>Publicadores</span><span
                            id="toggleIcon">▼</span></div>
                    <div id="dataTableContent" class="collapsible-content">
                        <div id="data-container" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>

            <div id="schedule-section" class="content-section hidden">
                <div class="mb-8 p-6 bg-gray-800 rounded-lg shadow-md">
                    <div class="no-print">
                        <h2 class="text-2xl font-semibold text-gray-200 mb-4">Gerador de Escala</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div>
                                <label for="scheduleMonth" class="block text-sm font-medium text-gray-400">Mês:</label>
                                <select id="scheduleMonth"
                                    class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md"></select>
                            </div>
                            <div>
                                <label for="scheduleYear" class="block text-sm font-medium text-gray-400">Ano:</label>
                                <input type="number" id="scheduleYear" value="2025" min="2024" max="2050"
                                    class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                            </div>
                             <div>
                                <label for="shiftStartTime" class="block text-sm font-medium text-gray-400">Horário de Entrada:</label>
                                <input type="time" id="shiftStartTime" value="09:00" class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                            </div>
                            <div>
                                <label for="shiftEndTime" class="block text-sm font-medium text-gray-400">Horário de Saída:</label>
                                <input type="time" id="shiftEndTime" value="17:00" class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4">
                            <button id="generateScheduleBtn"
                                class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transform hover:scale-105">Gerar
                                Escala</button>
                            <button id="saveScheduleBtn"
                                class="flex-1 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transform hover:scale-105 hidden">Salvar Escala</button>
                            <button id="printScheduleBtn"
                                class="flex-1 px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transform hover:scale-105 hidden">Imprimir
                                Escala</button>
                        </div>
                    </div>
                    <div id="schedule-output" class="mt-6"></div>
                </div>
            </div>

            <div id="occurrences-section" class="content-section hidden">
                <div class="flex flex-col md:flex-row-reverse gap-6">
                    <aside id="occurrence-filters"
                        class="w-full md:w-64 flex-shrink-0 bg-gray-800 p-4 rounded-lg shadow-md no-print self-start">
                        <h3 class="font-semibold text-lg mb-4 text-gray-300">Filtrar Ocorrências</h3>
                        <div><label for="filterYear" class="block text-sm font-medium text-gray-400">Ano</label><select
                                id="filterYear"
                                class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md"></select></div>
                        <div class="mt-4"><label class="block text-sm font-medium text-gray-400">Mês</label>
                            <div id="filterMonth" class="mt-1 space-y-1"></div>
                        </div>
                    </aside>
                    <div class="flex-grow">
                        <div class="mb-8 p-6 bg-gray-800 rounded-lg shadow-md no-print">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-semibold text-gray-200">Registro de Ocorrências</h2><button
                                    id="printOccurrencesBtn"
                                    class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transform hover:scale-105">Imprimir
                                    Ocorrências</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div><label for="occurrenceDate" class="block text-sm font-medium text-gray-400">Data da
                                        Ocorrência:</label><input type="date" id="occurrenceDate"
                                        class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md"></div>
                                <div><label for="occurrencePeople" class="block text-sm font-medium text-gray-400">No
                                        turno:</label><select id="occurrencePeople" multiple
                                        class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md h-32"></select>
                                </div>
                            </div>
                            <div class="mb-4"><label for="occurrenceImages"
                                    class="block text-sm font-medium text-gray-400">Imagens da Ocorrência:</label><input
                                    type="file" id="occurrenceImages" multiple accept="image/*"
                                    class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-900 file:text-blue-300 hover:file:bg-blue-800">
                            </div>
                            <div class="mb-4"><label for="occurrenceDescription"
                                    class="block text-sm font-medium text-gray-400">Descrição:</label><textarea
                                    id="occurrenceDescription" rows="4"
                                    class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md"
                                    placeholder="Descreva o que aconteceu..."></textarea></div><button
                                id="addOccurrenceBtn"
                                class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 w-full transform hover:scale-105">Salvar
                                Ocorrência</button>
                        </div>
                        <div id="occurrences-list" class="mt-6"></div>
                    </div>
                </div>
            </div>

            <div id="events-section" class="content-section hidden">
                <div class="mb-8">
                    <div id="eventFormToggle" class="collapsible-header no-print"><span>Adicionar Evento</span><span
                            id="eventToggleIcon">►</span></div>
                    <div id="eventFormContent" class="collapsible-content hidden">
                        <div class="p-6 bg-gray-800 rounded-lg shadow-md no-print">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                <input type="date" id="newEventDate" class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                                <select id="newEventName" class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                                    <option value="Assembleia" selected>Assembleia</option>
                                    <option value="Congresso">Congresso</option>
                                </select>
                                <input type="number" id="newEventPublishers" placeholder="Publicadores Estimados"
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                                <input type="number" id="newEventQuantity" placeholder="Assistência Estimada"
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                                <input type="number" id="newEventWeekends" placeholder="Fins de Semana Usados"
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                                <input type="number" id="newEventCongregations" placeholder="Nº de Congregações"
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                                <input type="text" id="newEventCircuits" placeholder="Circuitos (ex: SP-01, SP-02)"
                                    class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md lg:col-span-2">
                                <select id="newEventSpeakerType" class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md">
                                    <option value="">Selecione o Orador</option>
                                    <option value="circuit">Superintendente de Circuito</option>
                                    <option value="bethel">Representante de Betel</option>
                                </select>
                                <div id="circuitSpeakerContainer" class="hidden lg:col-span-3"><input type="text"
                                        id="newEventCircuitSpeaker" placeholder="Nome do Sup. de Circuito"
                                        class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md w-full"></div>
                                <div id="bethelSpeakerContainer" class="hidden lg:col-span-3"><input type="text"
                                        id="newEventBethelSpeaker" placeholder="Nome do Rep. de Betel"
                                        class="p-2 border border-gray-600 bg-gray-700 text-gray-200 rounded-md w-full"></div>
                            </div>
                            <button id="addEventBtn"
                                class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 w-full transform hover:scale-105">Salvar
                                Evento</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row-reverse gap-6">
                    <aside id="event-filters"
                        class="w-full md:w-64 flex-shrink-0 bg-gray-800 p-4 rounded-lg shadow-md no-print self-start">
                        <h3 class="font-semibold text-lg mb-4 text-gray-300">Opções e Filtros</h3>
                        <div class="flex flex-col gap-3">
                             <input type="file" id="eventsExcelFile" accept=".xlsx, .xls, .csv" class="hidden">
                             <button id="loadEventsExcelBtn"
                                 class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Carregar Planilha</button>
                             <button id="exportEventsExcelBtn"
                                 class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Exportar Planilha</button>
                             <button id="clearAllEventsBtn"
                                class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">Limpar
                                Eventos</button>
                        </div>
                        <hr class="my-4 border-gray-600">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Ano</label>
                            <div id="eventFilterYearButtons" class="flex flex-wrap gap-2">
                                <!-- Year buttons will be generated here by JS -->
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Mês</label>
                            <div id="eventFilterMonthButtons" class="grid grid-cols-3 gap-2">
                                <!-- Month buttons will be generated here by JS -->
                            </div>
                        </div>
                    </aside>

                    <div class="flex-grow">
                        <div class="flex justify-between items-center mb-4 no-print">
                            <h2 class="text-2xl font-semibold text-gray-200">Eventos Registrados</h2>
                            <div class="flex gap-2">
                                <button id="showSummaryBtn"
                                    class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transform hover:scale-105">Ver
                                    Resumo</button>
                                <button id="printEventsBtn"
                                    class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transform hover:scale-105">Imprimir</button>
                            </div>
                        </div>
                        <div id="event-tabs" class="flex border-b border-gray-700 no-print">
                            <button id="all-tab-btn" class="event-tab active">Todos</button>
                            <button id="circuit-tab-btn" class="event-tab">Superintendente de Circuito</button>
                            <button id="bethel-tab-btn" class="event-tab">Representante de Betel</button>
                        </div>
                        <div id="all-events-list" class="event-tab-content pt-4"></div>
                        <div id="circuit-events-list" class="event-tab-content pt-4 hidden"></div>
                        <div id="bethel-events-list" class="event-tab-content pt-4 hidden"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- SCRIPT START ---

        // Global state variables
        var peopleData = [], occurrencesData = [], eventsData = [];
        let currentSchedule = [], congressDatePicker, currentFilterYear = new Date().getFullYear(), currentFilterMonth = -1, eventFilterYear = 'all', eventFilterMonth = -1, summaryChartInstance = null;

        // --- DOM Elements Cache ---
        const D = (id) => document.getElementById(id);
        const loadingScreen = D('loading-screen'), sectionLoadingScreen = D('section-loading-screen'), mainTitle = D('main-title'),
            navInfo = D('nav-info'), navSchedule = D('nav-schedule'), navOccurrences = D('nav-occurrences'), navEvents = D('nav-events'),
            infoSection = D('info-section'), scheduleSection = D('schedule-section'), occurrencesSection = D('occurrences-section'), eventsSection = D('events-section'),
            excelFileInput = D('excelFile'), loadExcelButton = D('loadExcel'), saveDataButton = D('saveData'), loadDataButton = D('loadData'),
            exportExcelButton = D('exportExcel'), deleteSelectedButton = D('deleteSelectedBtn'), clearAllDataBtn = D('clearAllDataBtn'),
            dataContainer = D('data-container'), messageBox = D('message-box'), newNameInput = D('newName'),
            newMeetingDayWeekdaySelect = D('newMeetingDayWeekday'), newMeetingDayWeekendSelect = D('newMeetingDayWeekend'), newStatusSelect = D('newStatus'),
            coupleContainer = D('couple-container'), newSpouseNameInput = D('newSpouseName'), mainPersonGenderContainer = D('main-person-gender-container'),
            newGenderSelect = D('newGender'), spouseGenderContainer = D('spouse-gender-container'), newSpouseGenderSelect = D('newSpouseGender'),
            newCongressDatesInput = D('newCongressDates'), newSegCheckbox = D('newSeg'), newTerCheckbox = D('newTer'),
            newQuaCheckbox = D('newQua'), newQuiCheckbox = D('newQui'), newSexCheckbox = D('newSex'),
            newSabCheckbox = D('newSab'), newDomCheckbox = D('newDom'), addPersonBtn = D('addPersonBtn'),
            scheduleMonthSelect = D('scheduleMonth'), scheduleYearInput = D('scheduleYear'), 
            shiftStartTimeInput = D('shiftStartTime'), shiftEndTimeInput = D('shiftEndTime'),
            generateScheduleBtn = D('generateScheduleBtn'),
            printScheduleBtn = D('printScheduleBtn'), saveScheduleBtn = D('saveScheduleBtn'), scheduleOutputDiv = D('schedule-output'), occurrenceDateInput = D('occurrenceDate'),
            occurrencePeopleSelect = D('occurrencePeople'), occurrenceImagesInput = D('occurrenceImages'),
            occurrenceDescriptionInput = D('occurrenceDescription'), addOccurrenceBtn = D('addOccurrenceBtn'),
            printOccurrencesBtn = D('printOccurrencesBtn'), occurrencesListDiv = D('occurrences-list'),
            dataTableToggle = D('dataTableToggle'), dataTableContent = D('dataTableContent'), toggleIcon = D('toggleIcon'),
            addPersonFormToggle = D('addPersonFormToggle'), addPersonFormContent = D('addPersonFormContent'), addPersonToggleIcon = D('addPersonToggleIcon'),
            confirmModal = D('custom-confirm-modal'), confirmModalText = D('confirm-modal-text'),
            confirmModalYes = D('confirm-modal-yes'), confirmModalNo = D('confirm-modal-no'), summaryModal = D('summary-modal'),
            summaryModalClose = D('summary-modal-close'); let confirmCallback = null;
        const menuToggle = D('menu-toggle'), sidebar = D('navbar'), mainContent = D('main-content'),
            sidebarOverlay = D('sidebar-overlay'), menuOpenIcon = D('menu-open-icon'), menuCloseIcon = D('menu-close-icon'),
            filterYearSelect = D('filterYear'), filterMonthDiv = D('filterMonth'), newEventDateInput = D('newEventDate'),
            newEventNameSelect = D('newEventName'), newEventPublishersInput = D('newEventPublishers'), newEventQuantityInput = D('newEventQuantity'),
            newEventWeekendsInput = D('newEventWeekends'), newEventCongregationsInput = D('newEventCongregations'),
            newEventCircuitsInput = D('newEventCircuits'), newEventSpeakerTypeSelect = D('newEventSpeakerType'),
            bethelSpeakerContainer = D('bethelSpeakerContainer'), newEventBethelSpeakerInput = D('newEventBethelSpeaker'),
            circuitSpeakerContainer = D('circuitSpeakerContainer'), newEventCircuitSpeakerInput = D('newEventCircuitSpeaker'),
            addEventBtn = D('addEventBtn'), printEventsBtn = D('printEventsBtn'), showSummaryBtn = D('showSummaryBtn'),
            allTabBtn = D('all-tab-btn'), circuitTabBtn = D('circuit-tab-btn'), bethelTabBtn = D('bethel-tab-btn'),
            allEventsList = D('all-events-list'), circuitEventsList = D('circuit-events-list'), bethelEventsList = D('bethel-events-list'),
            eventFormToggle = D('eventFormToggle'), eventFormContent = D('eventFormContent'), eventToggleIcon = D('eventToggleIcon'),
            eventFiltersAside = D('event-filters'),
            eventsExcelFileInput = D('eventsExcelFile'), loadEventsExcelBtn = D('loadEventsExcelBtn'), exportEventsExcelBtn = D('exportEventsExcelBtn'), clearAllEventsBtn = D('clearAllEventsBtn');
        const loadDataFileInput = document.createElement('input');
        loadDataFileInput.type = 'file'; loadDataFileInput.accept = '.json'; loadDataFileInput.style.display = 'none'; document.body.appendChild(loadDataFileInput);

        // --- CORE FUNCTIONS (Messaging, Modals, Data Persistence) ---
        function showMessage(message, type = 'info') { messageBox.textContent = message; messageBox.className = 'p-4 mb-4 text-sm text-center rounded-lg no-print'; messageBox.classList.remove('hidden'); if (type === 'success') { messageBox.classList.add('bg-green-100', 'text-green-800'); } else if (type === 'error') { messageBox.classList.add('bg-red-100', 'text-red-800'); } else { messageBox.classList.add('bg-blue-100', 'text-blue-800'); } setTimeout(() => messageBox.classList.add('hidden'), 5000); }
        function showConfirmModal(message, callback) { confirmModalText.textContent = message; confirmCallback = callback; confirmModal.classList.add('visible'); }
        function saveDataToLocalStorage() { try { const appData = { people: peopleData, occurrences: occurrencesData, events: eventsData }; localStorage.setItem('organizationalAppData', JSON.stringify(appData)); } catch (error) { console.error("Error saving to LS:", error); showMessage('Erro ao salvar os dados localmente.', 'error'); } }
        function loadDataFromLocalStorage() { try { const storedData = localStorage.getItem('organizationalAppData'); if (storedData) { const appData = JSON.parse(storedData); peopleData = appData.people || []; occurrencesData = appData.occurrences || []; eventsData = appData.events || []; renderAll(); showMessage('Dados carregados com sucesso!', 'success'); } else { showMessage('Nenhum dado salvo localmente foi encontrado.', 'info'); } } catch (error) { console.error("Error loading from LS:", error); showMessage('Erro ao carregar os dados locais.', 'error'); } }
        function saveDataToFile() { if (peopleData.length === 0 && occurrencesData.length === 0 && eventsData.length === 0) { showMessage('Nenhum dado para salvar.', 'info'); return; } try { const appData = { people: peopleData, occurrences: occurrencesData, events: eventsData }; const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'organizational_database.json'; a.click(); URL.revokeObjectURL(url); showMessage('Dados salvos!', 'success'); } catch (error) { showMessage('Erro ao salvar os dados no arquivo.', 'error'); } }
        function loadDataFromFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const appData = JSON.parse(e.target.result); if (typeof appData === 'object' && appData !== null) { peopleData = appData.people || []; occurrencesData = appData.occurrences || []; eventsData = appData.events || []; renderAll(); showMessage('Dados carregados do arquivo!', 'success'); saveDataToLocalStorage(); } else { showMessage('Formato de arquivo inválido.', 'error'); } } catch (error) { showMessage('Erro ao processar o arquivo de dados.', 'error'); } }; reader.readAsText(file); }

        function renderAll() {
            renderData();
            populateOccurrencePeopleSelect();
            renderOccurrences();
            renderEvents();
            scheduleOutputDiv.innerHTML = '';
            printScheduleBtn.classList.add('hidden');
            saveScheduleBtn.classList.add('hidden');
        }
        
        // --- PEOPLE MANAGEMENT FUNCTIONS ---
        function renderData() {
            dataContainer.innerHTML = '';
            if (peopleData.length === 0) {
                dataContainer.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhum publicador cadastrado. Adicione um publicador ou carregue um arquivo.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full border-collapse mt-6 bg-gray-800 rounded-lg overflow-hidden shadow-md data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="p-4 w-12 text-center border-b border-gray-700"><input type="checkbox" id="selectAllCheckbox" class="form-checkbox bg-gray-700 border-gray-600"></th>
                        <th class="p-4 text-left border-b border-gray-700">Publicador</th>
                        <th class="p-4 text-left border-b border-gray-700">Reuniões</th>
                        <th class="p-4 text-left border-b border-gray-700">Disponibilidade Semanal</th>
                        <th class="p-4 w-24 text-center border-b border-gray-700">Ações</th>
                        <th class="p-4 w-12 text-center border-b border-gray-700"></th> <!-- Expander column -->
                    </tr>
                </thead>
                <tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            const daysOfWeekMapping = { 'segunda': 'S', 'terca': 'T', 'quarta': 'Q', 'quinta': 'Q', 'sexta': 'S', 'sabado': 'S', 'domingo': 'D' };
            const dayKeys = Object.keys(daysOfWeekMapping);

            peopleData.forEach((person, index) => {
                const tr = tbody.insertRow();
                tr.className = 'main-row';
                tr.dataset.index = index;

                let checkboxCell = tr.insertCell();
                checkboxCell.className = 'p-4 border-b border-gray-700 text-center align-middle';
                checkboxCell.innerHTML = `<input type="checkbox" class="row-checkbox form-checkbox bg-gray-700 border-gray-600" data-index="${index}">`;

                let nameCell = tr.insertCell();
                nameCell.className = 'p-4 border-b border-gray-700 align-middle editable-text-cell';
                nameCell.dataset.field = 'name';
                nameCell.dataset.index = index;
                nameCell.textContent = person.name || 'N/A';

                let meetingsCell = tr.insertCell();
                meetingsCell.className = 'p-4 border-b border-gray-700 align-middle text-sm';
                const meetingWeekday = person.meetingDayWeekday ? person.meetingDayWeekday.charAt(0).toUpperCase() + person.meetingDayWeekday.slice(1) : 'Nenhuma';
                const meetingWeekend = person.meetingDayWeekend ? person.meetingDayWeekend.charAt(0).toUpperCase() + person.meetingDayWeekend.slice(1) : 'Nenhuma';
                meetingsCell.innerHTML = `<div>Semana: <span class="font-semibold editable-text-cell p-1" data-field="meetingDayWeekday" data-index="${index}">${meetingWeekday}</span></div><div>FDS: <span class="font-semibold editable-text-cell p-1" data-field="meetingDayWeekend" data-index="${index}">${meetingWeekend}</span></div>`;

                let availabilityCell = tr.insertCell();
                availabilityCell.className = 'p-4 border-b border-gray-700 align-middle';
                let availabilityHtml = '<div class="flex flex-wrap gap-1">';
                dayKeys.forEach(dayKey => {
                    const isAvailable = person[dayKey];
                    const bgColor = isAvailable ? 'bg-green-500' : 'bg-red-500';
                    const dayInitial = daysOfWeekMapping[dayKey];
                    availabilityHtml += `<span class="day-cell w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${bgColor} text-white" data-field="${dayKey}" data-index="${index}">${dayInitial}</span>`;
                });
                availabilityHtml += '</div>';
                availabilityCell.innerHTML = availabilityHtml;

                let actionsCell = tr.insertCell();
                actionsCell.className = 'p-4 border-b border-gray-700 text-center align-middle';
                actionsCell.innerHTML = `<button class="px-3 py-1 bg-red-600 text-white rounded-md text-sm delete-person-btn" data-index="${index}">Excluir</button>`;

                let expanderCell = tr.insertCell();
                expanderCell.className = 'p-4 border-b border-gray-700 text-center align-middle';
                expanderCell.innerHTML = `<button class="expand-btn text-blue-400 text-xl transform transition-transform duration-200">▼</button>`;

                const trDetails = tbody.insertRow();
                trDetails.className = 'hidden';
                const detailsCell = trDetails.insertCell();
                detailsCell.colSpan = 6;
                detailsCell.className = 'p-4 bg-gray-900';
                
                const formattedCongressDates = (person.congress || []).map(dateStr => {
                    const date = new Date(dateStr + 'T00:00:00');
                    return isNaN(date) ? dateStr : date.toLocaleDateString('pt-BR');
                }).join(', ');

                detailsCell.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div><strong>Gênero:</strong> <span class="editable-text-cell p-1" data-field="gender" data-index="${index}">${person.gender || 'N/A'}</span></div>
                        <div><strong>Cônjuge:</strong> <span class="editable-text-cell p-1" data-field="spouseName" data-index="${index}">${person.spouseName || 'N/A'}</span></div>
                        <div><strong>Congresso:</strong> <span class="editable-text-cell p-1" data-field="congress" data-index="${index}">${formattedCongressDates || 'N/A'}</span></div>
                    </div>
                `;
            });

            dataContainer.appendChild(table);
            addTableEventListeners();
        }

        function addTableEventListeners() {
            document.querySelectorAll('.editable-text-cell').forEach(cell => cell.addEventListener('click', handleTextCellEdit));
            document.querySelectorAll('.day-cell').forEach(cell => cell.addEventListener('click', handleDayCellToggle));
            D('selectAllCheckbox')?.addEventListener('change', handleSelectAll);
            document.querySelectorAll('.row-checkbox').forEach(checkbox => checkbox.addEventListener('change', handleRowCheckboxChange));
            document.querySelectorAll('.delete-person-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePerson(parseInt(e.target.dataset.index));
                });
            });
            document.querySelectorAll('.expand-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const detailsRow = e.target.closest('tr').nextElementSibling;
                    detailsRow.classList.toggle('hidden');
                    e.target.classList.toggle('rotate-180');
                });
            });
        }

        function addPerson() {
            const name = newNameInput.value.trim();
            if (!name) { showMessage('O nome é obrigatório.', 'error'); return; }
            const status = newStatusSelect.value;
            const spouseName = (status === 'Casal') ? newSpouseNameInput.value.trim() : '';
            const gender = newGenderSelect.value;
            if (status === 'Casal' && !spouseName) { showMessage('O nome do cônjuge é obrigatório para o status "Casal".', 'error'); return; }

            let congressDates = [];
            if (congressDatePicker.selectedDates.length > 0) {
                const start = congressDatePicker.selectedDates[0];
                const end = congressDatePicker.selectedDates.length > 1 ? congressDatePicker.selectedDates[1] : start;
                let currentDate = new Date(start);
                while (currentDate <= end) {
                    congressDates.push(flatpickr.formatDate(currentDate, "Y-m-d"));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            const commonData = { meetingDayWeekday: newMeetingDayWeekdaySelect.value, meetingDayWeekend: newMeetingDayWeekendSelect.value, congress: congressDates, segunda: newSegCheckbox.checked, terca: newTerCheckbox.checked, quarta: newQuaCheckbox.checked, quinta: newQuiCheckbox.checked, sexta: newSexCheckbox.checked, sabado: newSabCheckbox.checked, domingo: newDomCheckbox.checked };
            
            if (status === 'Casal') {
                const spouseGender = newSpouseGenderSelect.value;
                peopleData.push({ ...commonData, name: name, gender: gender, status: status, spouseName: spouseName });
                peopleData.push({ ...commonData, name: spouseName, gender: spouseGender, status: status, spouseName: name });
            } else {
                peopleData.push({ ...commonData, name: name, gender: gender, status: status, spouseName: '' });
            }

            renderAll();
            saveDataToLocalStorage();
            showMessage('Publicador(es) adicionado(s) com sucesso!', 'success');
            
            // Reset form
            newNameInput.value = '';
            newStatusSelect.value = 'Solteiro(a)';
            newSpouseNameInput.value = '';
            coupleContainer.classList.add('hidden');
            mainPersonGenderContainer.classList.remove('hidden');
            newMeetingDayWeekdaySelect.value = '';
            newMeetingDayWeekendSelect.value = '';
            congressDatePicker.clear();
            [newSegCheckbox, newTerCheckbox, newQuaCheckbox, newQuiCheckbox, newSexCheckbox, newSabCheckbox, newDomCheckbox].forEach(cb => cb.checked = true);
        }

        function deletePerson(index) {
            showConfirmModal('Tem certeza que deseja excluir este publicador?', (confirmed) => {
                if (confirmed) {
                    peopleData.splice(index, 1);
                    renderAll();
                    saveDataToLocalStorage();
                    showMessage('Publicador excluído com sucesso!', 'success');
                }
            });
        }

        function deleteSelectedPeople() {
            const selectedIndices = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.dataset.index));
            if (selectedIndices.length === 0) {
                showMessage('Nenhum publicador selecionado.', 'info');
                return;
            }
            showConfirmModal(`Tem certeza que deseja excluir ${selectedIndices.length} publicador(es)?`, (confirmed) => {
                if (confirmed) {
                    selectedIndices.sort((a, b) => b - a).forEach(index => peopleData.splice(index, 1));
                    renderAll();
                    saveDataToLocalStorage();
                    showMessage(`${selectedIndices.length} publicador(es) excluído(s)!`, 'success');
                }
            });
        }

        function handleSelectAll(event) {
            document.querySelectorAll('.row-checkbox').forEach(checkbox => checkbox.checked = event.target.checked);
        }

        function handleRowCheckboxChange() {
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            const selectAll = D('selectAllCheckbox');
            if (selectAll) {
                selectAll.checked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
            }
        }

        function handleDayCellToggle(event) {
            const cell = event.target;
            const index = parseInt(cell.dataset.index);
            const field = cell.dataset.field;
            peopleData[index][field] = !peopleData[index][field];
            renderData();
            saveDataToLocalStorage();
        }

        function handleTextCellEdit(event) {
            const cell = event.target;
            const index = parseInt(cell.dataset.index);
            const field = cell.dataset.field;
            if (cell.querySelector('input') || cell.querySelector('select')) return;

            const currentValue = peopleData[index][field];
            let inputElement;

            const createSelect = (options, selectedValue) => {
                const select = document.createElement('select');
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (opt.value === selectedValue) option.selected = true;
                    select.appendChild(option);
                });
                return select;
            };

            if (field === 'status') {
                inputElement = createSelect([{ value: 'Solteiro(a)', text: 'Solteiro(a)' }, { value: 'Casal', text: 'Casal' }], currentValue);
            } else if (field === 'gender') {
                inputElement = createSelect([{ value: 'Masculino', text: 'Masculino' }, { value: 'Feminino', text: 'Feminino' }], currentValue);
            } else if (field === 'congress') {
                const tempInput = document.createElement('input');
                tempInput.type = 'hidden';
                cell.appendChild(tempInput);
                const defaultDate = (Array.isArray(currentValue) && currentValue.length > 0) ? [currentValue[0], currentValue[currentValue.length - 1]] : [];
                const picker = flatpickr(tempInput, {
                    mode: "range",
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "d/m/Y",
                    defaultDate: defaultDate,
                    locale: "pt",
                    onClose: function(selectedDates) {
                        let newCongressDates = [];
                        if (selectedDates.length === 2) {
                            const [start, end] = selectedDates;
                            let currentDate = new Date(start);
                            while (currentDate <= end) {
                                newCongressDates.push(flatpickr.formatDate(currentDate, "Y-m-d"));
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                        } else if (selectedDates.length === 1) {
                            newCongressDates.push(flatpickr.formatDate(selectedDates[0], "Y-m-d"));
                        }
                        peopleData[index][field] = newCongressDates;
                        renderData();
                        saveDataToLocalStorage();
                    },
                    appendTo: cell
                });
                picker.open();
                return;
            } else if (field === 'meetingDayWeekday') {
                inputElement = createSelect([{ value: '', text: 'Nenhuma' }, { value: 'segunda', text: 'Segunda-feira' }, { value: 'terca', text: 'Terça-feira' }, { value: 'quarta', text: 'Quarta-feira' }, { value: 'quinta', text: 'Quinta-feira' }, { value: 'sexta', text: 'Sexta-feira' }], currentValue);
            } else if (field === 'meetingDayWeekend') {
                inputElement = createSelect([{ value: '', text: 'Nenhuma' }, { value: 'sabado', text: 'Sábado' }, { value: 'domingo', text: 'Domingo' }, { value: 'final de semana', text: 'Fim de Semana' }], currentValue);
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.value = currentValue || '';
            }

            inputElement.className = 'w-full p-1 border border-blue-400 rounded-md';
            const saveChanges = () => {
                const oldValue = peopleData[index][field];
                const newValue = inputElement.value;
                peopleData[index][field] = newValue;
                
                // Update availability based on meeting day change
                if (field === 'meetingDayWeekday' || field === 'meetingDayWeekend') {
                    // Make old day available
                    if (oldValue && oldValue !== 'final de semana') peopleData[index][oldValue] = true;
                    if (oldValue === 'final de semana') {
                        peopleData[index]['sabado'] = true;
                        peopleData[index]['domingo'] = true;
                    }
                    // Make new day unavailable
                    if (newValue && newValue !== 'final de semana') peopleData[index][newValue] = false;
                    if (newValue === 'final de semana') {
                        peopleData[index]['sabado'] = false;
                        peopleData[index]['domingo'] = false;
                    }
                }

                renderData();
                saveDataToLocalStorage();
            };
            inputElement.addEventListener('blur', saveChanges);
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') inputElement.blur();
                else if (e.key === 'Escape') renderData();
            });
            cell.innerHTML = '';
            cell.appendChild(inputElement);
            inputElement.focus();
        }

        // --- OCCURRENCES FUNCTIONS ---
        function populateOccurrencePeopleSelect() {
            occurrencePeopleSelect.innerHTML = '';
            peopleData.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                occurrencePeopleSelect.appendChild(option);
            });
        }

        async function addOccurrence() {
            const date = occurrenceDateInput.value;
            const description = occurrenceDescriptionInput.value.trim();
            const selectedPeople = Array.from(occurrencePeopleSelect.selectedOptions).map(opt => opt.value);
            const files = occurrenceImagesInput.files;

            if (!date || !description || selectedPeople.length === 0) {
                showMessage('Por favor, preencha todos os campos da ocorrência.', 'error');
                return;
            }

            const images = await readFilesAsDataURLs(files);
            occurrencesData.push({ id: Date.now(), date: date, people: selectedPeople, description: description, images: images });
            renderOccurrences();
            saveDataToLocalStorage();
            showMessage('Ocorrência registrada com sucesso!', 'success');

            // Reset form
            occurrenceDateInput.value = '';
            occurrenceDescriptionInput.value = '';
            occurrencePeopleSelect.selectedIndex = -1;
            occurrenceImagesInput.value = '';
        }

        function readFilesAsDataURLs(files) {
            return Promise.all(Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }));
        }

        function renderOccurrences() {
            populateOccurrenceFilters();
            const filteredOccurrences = occurrencesData.filter(o => {
                const occurrenceDate = new Date(o.date + "T00:00:00");
                const yearMatch = occurrenceDate.getFullYear() === currentFilterYear;
                const monthMatch = currentFilterMonth === -1 || occurrenceDate.getMonth() === currentFilterMonth;
                return yearMatch && monthMatch;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            occurrencesListDiv.innerHTML = '<h3 class="text-xl font-semibold text-gray-300 mb-4">Ocorrências Registradas</h3>';
            if (filteredOccurrences.length === 0) {
                occurrencesListDiv.innerHTML += '<p class="text-gray-400">Nenhuma ocorrência encontrada para este período.</p>';
                return;
            }

            filteredOccurrences.forEach(o => {
                const occurrenceEl = document.createElement('div');
                occurrenceEl.className = 'bg-gray-800 p-4 rounded-lg shadow-md mb-4 fade-in';
                let imagesHtml = '';
                if (o.images && o.images.length > 0) {
                    imagesHtml += '<div class="flex flex-wrap gap-2 mb-2">';
                    o.images.forEach(imgData => {
                        imagesHtml += `<img src="${imgData}" class="w-32 h-32 object-cover rounded-md border" alt="Imagem da ocorrência">`;
                    });
                    imagesHtml += '</div>';
                }
                occurrenceEl.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-lg text-blue-400">${new Date(o.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>${imagesHtml}<p class="font-semibold text-gray-300 mt-1">No turno: ${o.people.join(', ')}</p><p class="text-gray-400 mt-2">${o.description.replace(/\n/g, '<br>')}</p></div><button class="px-3 py-1 bg-red-600 text-white rounded-md text-sm delete-occurrence-btn no-print" data-id="${o.id}">Excluir</button></div>`;
                occurrencesListDiv.appendChild(occurrenceEl);
            });

            document.querySelectorAll('.delete-occurrence-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idToDelete = parseInt(e.target.dataset.id);
                    showConfirmModal('Tem certeza que deseja excluir esta ocorrência?', (confirmed) => {
                        if (confirmed) {
                            occurrencesData = occurrencesData.filter(o => o.id !== idToDelete);
                            renderOccurrences();
                            saveDataToLocalStorage();
                            showMessage('Ocorrência excluída.', 'success');
                        }
                    });
                });
            });
        }

        function populateOccurrenceFilters() {
            const years = [...new Set(occurrencesData.map(o => new Date(o.date + "T00:00:00").getFullYear()))].sort((a, b) => b - a);
            filterYearSelect.innerHTML = years.map(y => `<option value="${y}" ${y === currentFilterYear ? 'selected' : ''}>${y}</option>`).join('');
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            let monthsHtml = `<a href="#" data-month="-1" class="block p-2 rounded-md text-sm ${currentFilterMonth === -1 ? 'bg-blue-600 text-white' : 'hover:bg-gray-700'}">Todos os Meses</a>`;
            monthsHtml += monthNames.map((m, i) => `<a href="#" data-month="${i}" class="block p-2 rounded-md text-sm ${i === currentFilterMonth ? 'bg-blue-600 text-white' : 'hover:bg-gray-700'}">${m}</a>`).join('');
            filterMonthDiv.innerHTML = monthsHtml;
            filterMonthDiv.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentFilterMonth = parseInt(e.target.dataset.month);
                    renderOccurrences();
                });
            });
        }
        
        // --- SCHEDULE FUNCTIONS ---
        const dayNamesShort = ["domingo", "segunda", "terca", "quarta", "quinta", "sexta", "sabado"];
        
        function populateScheduleControls() {
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            scheduleMonthSelect.innerHTML = monthNames.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            scheduleMonthSelect.value = new Date().getMonth();
            scheduleYearInput.value = new Date().getFullYear();
        }

        function getWeekOfMonth(date) {
            const day = date.getDate();
            return Math.ceil(day / 7);
        }

        function assignCouples(availablePeople, workCount, coupleWorkCount, maxAssignments, prioritize) {
            const attendants = [];
            const watchmen = [];
            let availableCoupleMen = availablePeople.filter(p => p.gender === 'Masculino' && p.status === 'Casal' && p.spouseName);
            let menToAssign = [];

            if (prioritize) {
                let priorityMen = availableCoupleMen
                    .filter(m => coupleWorkCount[m.name] < 2)
                    .sort((a, b) => (coupleWorkCount[a.name] - coupleWorkCount[b.name]) || (workCount[a.name] - workCount[b.name]));
                let normalMen = availableCoupleMen
                    .filter(m => coupleWorkCount[m.name] >= 2)
                    .sort((a, b) => (coupleWorkCount[a.name] - coupleWorkCount[b.name]) || (workCount[a.name] - workCount[b.name]));
                menToAssign = [...priorityMen, ...normalMen];
            } else {
                menToAssign = availableCoupleMen.sort((a, b) => workCount[a.name] - workCount[b.name]);
            }

            let assignedCount = 0;
            while (assignedCount < maxAssignments && menToAssign.length > 0) {
                let assignedInLoop = false;
                for (let j = 0; j < menToAssign.length; j++) {
                    const man = menToAssign[j];
                    const spouse = availablePeople.find(p => p.name === man.spouseName);
                    if (man && spouse) {
                        watchmen.push(man.name);
                        attendants.push(spouse.name);
                        workCount[man.name]++;
                        workCount[spouse.name]++;
                        if (coupleWorkCount.hasOwnProperty(man.name)) coupleWorkCount[man.name]++;
                        availablePeople = availablePeople.filter(p => p.name !== man.name && p.name !== spouse.name);
                        menToAssign.splice(j, 1);
                        assignedInLoop = true;
                        break;
                    }
                }
                if (assignedInLoop) {
                    assignedCount++;
                } else {
                    break;
                }
            }

            while(attendants.length < maxAssignments) attendants.push('VAGO');
            while(watchmen.length < maxAssignments) watchmen.push('VAGO');
            
            return { attendants, watchmen };
        }

        function generateSchedule() {
            if (peopleData.length === 0) {
                showMessage('Não há publicadores cadastrados para gerar a escala.', 'error');
                return;
            }
            sectionLoadingScreen.classList.add('visible');

            setTimeout(() => {
                const month = parseInt(scheduleMonthSelect.value);
                const year = parseInt(scheduleYearInput.value);
                const startTime = shiftStartTimeInput.value;
                const endTime = shiftEndTimeInput.value;
                const workCount = peopleData.reduce((acc, person) => ({ ...acc, [person.name]: 0 }), {});
                const coupleWorkCount = {};
                peopleData.filter(p => p.status === 'Casal' && p.gender === 'Masculino').forEach(p => coupleWorkCount[p.name] = 0);
                currentSchedule = [];

                for (let day = 1; day <= new Date(year, month + 1, 0).getDate(); day++) {
                    const date = new Date(year, month, day);
                    const dayName = dayNamesShort[date.getDay()];
                    const currentDateStr = flatpickr.formatDate(date, "Y-m-d");
                    const hasEvent = eventsData.some(event => event.date === currentDateStr);
                    const weekType = hasEvent ? 'com_evento' : 'sem_evento';
                    
                    const assignments = [];

                    let availablePeople = peopleData.filter(person => {
                        let isAvailable = person[dayName];
                        if (isAvailable && Array.isArray(person.congress) && person.congress.includes(currentDateStr)) isAvailable = false;
                        if (isAvailable && person.meetingDayWeekday === dayName) isAvailable = false;
                        if (isAvailable && (person.meetingDayWeekend === dayName || (person.meetingDayWeekend === 'final de semana' && (dayName === 'sabado' || dayName === 'domingo')))) isAvailable = false;
                        return isAvailable;
                    });
                    
                    const isWeekend = (dayName === 'sabado' || dayName === 'domingo');
                    let maxAssignments = 1;

                    if (isWeekend) {
                        if (month === 7 && year === 2025) { // August 2025 has a congress
                            maxAssignments = 1;
                        } else if (weekType === 'sem_evento') {
                            maxAssignments = 3;
                        }
                    }

                    if (maxAssignments > 1) {
                        const result = assignCouples([...availablePeople], workCount, coupleWorkCount, maxAssignments, true);
                        
                        const start = new Date(`1970-01-01T${startTime}`);
                        const end = new Date(`1970-01-01T${endTime}`);
                        const durationMinutes = (end - start) / 60000;
                        const shiftDuration = Math.floor(durationMinutes / maxAssignments);
                        const formatTime = (date) => date.toTimeString().substring(0, 5);

                        for (let i = 0; i < maxAssignments; i++) {
                            const shiftStart = new Date(start.getTime() + i * shiftDuration * 60000);
                            const shiftEnd = new Date(shiftStart.getTime() + shiftDuration * 60000);
                            assignments.push({
                                attendant: result.attendants[i],
                                watchman: result.watchmen[i],
                                startTime: formatTime(shiftStart),
                                endTime: (i === maxAssignments - 1) ? endTime : formatTime(shiftEnd)
                            });
                        }
                    } else {
                        const result = assignCouples([...availablePeople], workCount, coupleWorkCount, 1, true);
                        assignments.push({
                            attendant: result.attendants[0],
                            watchman: result.watchmen[0],
                            startTime: startTime,
                            endTime: endTime
                        });
                    }
                    currentSchedule.push({ date: currentDateStr, dayOfWeek: dayName, assignments: assignments });
                }
                renderScheduleCalendar();
                showMessage('Escala gerada com sucesso!', 'success');
                printScheduleBtn.classList.remove('hidden');
                saveScheduleBtn.classList.remove('hidden');
                sectionLoadingScreen.classList.remove('visible');
                sectionLoadingScreen.classList.add('hidden');
            }, 100);
        }

        function renderScheduleCalendar() {
            const month = parseInt(scheduleMonthSelect.value);
            const year = parseInt(scheduleYearInput.value);
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"];

            scheduleOutputDiv.innerHTML = ''; // Clear previous content

            const container = document.createElement('div');
            container.className = 'no-print-view';
            
            container.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-200 mb-6 text-center">${monthNames[month]} de ${year}</h3>
                <div class="grid grid-cols-7 gap-2 mb-2 text-center font-semibold text-gray-400">
                    ${dayNames.map(day => `<div>${day}</div>`).join('')}
                </div>
            `;

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-7 gap-2';
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'rounded-lg border border-gray-700 bg-gray-800/50 min-h-[110px]';
                grid.appendChild(emptyDay);
            }

            currentSchedule.forEach((entry, dayIndex) => {
                const dateObj = new Date(entry.date + 'T00:00:00');
                const dayOfMonth = dateObj.getDate();
                let dayClass = 'border-gray-700 bg-gray-800';
                if (entry.dayOfWeek === 'sabado') dayClass = 'bg-yellow-900/30 border-yellow-700';
                if (entry.dayOfWeek === 'domingo') dayClass = 'bg-red-900/30 border-red-800';

                const assignmentsHtml = entry.assignments.map((assign, assignIndex) => `
                    <div class="assignment-group border-t border-gray-700/50 pt-1 mt-1 first:mt-0 first:pt-0 first:border-0">
                        <div class="text-center text-xs font-bold text-gray-400 mb-1 editable-time cursor-pointer" data-day-index="${dayIndex}" data-assign-index="${assignIndex}">${assign.startTime} - ${assign.endTime}</div>
                        <div class="pl-1">
                            <span class="editable-team-member block truncate text-blue-400" data-day-index="${dayIndex}" data-assign-index="${assignIndex}" data-role="attendant">${assign.attendant}</span>
                            <span class="editable-team-member block truncate text-green-400" data-day-index="${dayIndex}" data-assign-index="${assignIndex}" data-role="watchman">${assign.watchman}</span>
                        </div>
                    </div>
                `).join('');
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `rounded-lg border p-1 flex flex-col ${dayClass} min-h-[110px] fade-in`;
                dayDiv.style.animationDelay = `${dayIndex * 20}ms`;
                
                dayDiv.innerHTML = `
                    <div class="font-bold text-right text-gray-300 text-sm">${dayOfMonth}</div>
                    <div class="mt-1 text-xs flex-grow space-y-1">
                        ${assignmentsHtml}
                    </div>
                `;
                grid.appendChild(dayDiv);
            });
            
            container.appendChild(grid);
            scheduleOutputDiv.appendChild(container);

            document.querySelectorAll('.editable-team-member').forEach(span => {
                span.addEventListener('click', handleScheduleTeamEdit);
            });
            document.querySelectorAll('.editable-time').forEach(span => {
                span.addEventListener('click', handleScheduleTimeEdit);
            });
        }


        function handleScheduleTeamEdit(event) {
            const span = event.target;
            if (span.querySelector('select')) return;
            const dayIndex = parseInt(span.dataset.dayIndex);
            const assignIndex = parseInt(span.dataset.assignIndex);
            const role = span.dataset.role;
            const scheduleEntry = currentSchedule[dayIndex];
            const originalName = span.textContent;

            const availablePeople = peopleData.filter(person => {
                let isAvailable = person[scheduleEntry.dayOfWeek];
                if (isAvailable && Array.isArray(person.congress) && person.congress.includes(scheduleEntry.date)) isAvailable = false;
                if (isAvailable && person.meetingDayWeekday === scheduleEntry.dayOfWeek) isAvailable = false;
                if (isAvailable && (person.meetingDayWeekend === scheduleEntry.dayOfWeek || (person.meetingDayWeekend === 'final de semana' && (scheduleEntry.dayOfWeek === 'sabado' || scheduleEntry.dayOfWeek === 'domingo')))) isAvailable = false;
                return isAvailable;
            });

            const genderForRole = role === 'attendant' ? 'Feminino' : 'Masculino';
            const roleSpecificOptions = availablePeople.filter(p => p.gender === genderForRole);
            const select = document.createElement('select');
            select.className = 'w-full p-1 border border-blue-400 rounded-md bg-gray-900 text-gray-200';
            let optionsHtml = `<option value="${originalName}">${originalName}</option>`;
            if (originalName !== 'VAGO') {
                optionsHtml += `<option value="VAGO">-- VAGO --</option>`;
            }
            roleSpecificOptions.forEach(p => {
                if (p.name !== originalName) {
                    optionsHtml += `<option value="${p.name}">${p.name}</option>`;
                }
            });
            select.innerHTML = optionsHtml;
            span.innerHTML = '';
            span.appendChild(select);
            select.focus();
            const saveChange = () => {
                currentSchedule[dayIndex].assignments[assignIndex][role] = select.value;
                renderScheduleCalendar();
            };
            select.addEventListener('blur', saveChange);
            select.addEventListener('change', saveChange);
        }

        function handleScheduleTimeEdit(event) {
            const span = event.target.closest('.editable-time');
            if (span.querySelector('input')) return;

            const dayIndex = parseInt(span.dataset.dayIndex);
            const assignIndex = parseInt(span.dataset.assignIndex);
            const assignment = currentSchedule[dayIndex].assignments[assignIndex];

            span.innerHTML = `
                <input type="time" value="${assignment.startTime}" class="bg-gray-900 border border-gray-600 rounded w-16 p-0 text-center text-gray-200">
                <input type="time" value="${assignment.endTime}" class="bg-gray-900 border border-gray-600 rounded w-16 p-0 text-center text-gray-200">
            `;

            const inputs = span.querySelectorAll('input');
            inputs[0].focus();

            const saveTimeChanges = () => {
                assignment.startTime = inputs[0].value;
                assignment.endTime = inputs[1].value;
                renderScheduleCalendar(); // Re-render to show changes and re-attach listeners
            };

            inputs.forEach(input => {
                input.addEventListener('blur', saveTimeChanges);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                    if (e.key === 'Escape') {
                        renderScheduleCalendar(); // Cancel edit
                    }
                });
            });
        }

        function saveScheduleToFile() {
            if (currentSchedule.length === 0) {
                showMessage('Nenhuma escala para salvar.', 'info');
                return;
            }

            const month = parseInt(scheduleMonthSelect.value);
            const year = parseInt(scheduleYearInput.value);
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const filename = `escala_${monthNames[month].toLowerCase()}_${year}.csv`;

            let csvContent = "Data;Dia da Semana;Horário Entrada;Horário Saída;Atendente;Vigia\n";
            const displayDayNames = { "segunda": "Segunda-feira", "terca": "Terça-feira", "quarta": "Quarta-feira", "quinta": "Quinta-feira", "sexta": "Sexta-feira", "sabado": "Sábado", "domingo": "Domingo" };

            currentSchedule.forEach(entry => {
                const dateObj = new Date(entry.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('pt-BR');
                const dayOfWeek = displayDayNames[entry.dayOfWeek];
                
                entry.assignments.forEach(assign => {
                    if (assign.attendant !== 'VAGO' || assign.watchman !== 'VAGO') {
                         const attendant = `"${assign.attendant}"`;
                         const watchman = `"${assign.watchman}"`;
                         csvContent += `${formattedDate};${dayOfWeek};${assign.startTime};${assign.endTime};${attendant};${watchman}\n`;
                    }
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('Escala salva com sucesso!', 'success');
        }

        // --- EVENTS FUNCTIONS ---
        function addEvent() {
            const date = newEventDateInput.value;
            const name = newEventNameSelect.value;
            const publishers = parseInt(newEventPublishersInput.value);
            const quantity = parseInt(newEventQuantityInput.value);
            const weekends = parseInt(newEventWeekendsInput.value);
            const congregations = parseInt(newEventCongregationsInput.value);
            const circuitsList = newEventCircuitsInput.value.trim();
            const circuits = circuitsList ? circuitsList.split(',').map(c => c.trim()).length : 0;
            const speakerType = newEventSpeakerTypeSelect.value;
            let speakerName = (speakerType === 'bethel') ? newEventBethelSpeakerInput.value.trim() : (speakerType === 'circuit') ? newEventCircuitSpeakerInput.value.trim() : '';

            if (!date || !name || isNaN(publishers) || isNaN(quantity) || isNaN(weekends) || isNaN(congregations) || !circuitsList || !speakerType || !speakerName) {
                showMessage('Por favor, preencha todos os campos do evento corretamente.', 'error');
                return;
            }

            eventsData.push({ id: Date.now(), date, name, publishers, quantity, weekends, congregations, circuits, circuitsList, speakerType, speakerName });
            renderEvents();
            saveDataToLocalStorage();
            showMessage('Evento salvo com sucesso!', 'success');
            
            // Reset form
            newEventDateInput.value = '';
            newEventNameSelect.value = 'Assembleia';
            newEventPublishersInput.value = '';
            newEventQuantityInput.value = '';
            newEventWeekendsInput.value = '';
            newEventCongregationsInput.value = '';
            newEventCircuitsInput.value = '';
            newEventSpeakerTypeSelect.value = '';
            newEventBethelSpeakerInput.value = '';
            newEventCircuitSpeakerInput.value = '';
            bethelSpeakerContainer.classList.add('hidden');
            circuitSpeakerContainer.classList.add('hidden');
        }

        function renderEvents() {
            populateEventFilters();
            const filteredEvents = eventsData.filter(e => {
                const eventDate = new Date(e.date + "T00:00:00");
                
                let yearMatch = false;
                if (eventFilterYear === 'all') {
                    yearMatch = eventDate.getFullYear() >= 2025;
                } else {
                    yearMatch = eventDate.getFullYear() === parseInt(eventFilterYear);
                }

                const monthMatch = eventFilterMonth === -1 || eventDate.getMonth() === eventFilterMonth;
                return yearMatch && monthMatch;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const circuitEvents = filteredEvents.filter(e => e.speakerType === 'circuit');
            const bethelEvents = filteredEvents.filter(e => e.speakerType === 'bethel');

            const renderEventList = (eventList, containerElement) => {
                if (eventList.length === 0) {
                    containerElement.innerHTML = `<p class="text-gray-400 p-4">Nenhum evento registrado para este período.</p>`;
                    return;
                }

                const eventsByDate = eventList.reduce((acc, event) => {
                    const date = event.date;
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(event);
                    return acc;
                }, {});

                let finalHtml = '';
                for (const date of Object.keys(eventsByDate).sort()) {
                    const eventsOnDay = eventsByDate[date];
                    const dateObj = new Date(date + 'T00:00:00');
                    
                    const totalQuantityForDay = eventsOnDay.reduce((sum, ev) => sum + ev.quantity, 0);
                    const totalPublishersForDay = eventsOnDay.reduce((sum, ev) => sum + ev.publishers, 0);

                    let auditoriumForDay;
                    if (totalQuantityForDay <= 50) {
                        auditoriumForDay = 'Auditório C';
                    } else if (totalQuantityForDay > 500) {
                        auditoriumForDay = 'Auditório A';
                    } else {
                        auditoriumForDay = 'Auditório B';
                    }
                    
                    let summaryHtml = '';
                    if (eventsOnDay.length > 1) {
                        summaryHtml = `
                            <div class="text-xs bg-blue-900/50 border border-blue-800 rounded-md p-2 ml-4">
                                <p class="font-bold">Total do Dia:</p>
                                <p><strong>Pubs:</strong> ${totalPublishersForDay}</p>
                                <p><strong>Assist.:</strong> ${totalQuantityForDay}</p>
                            </div>
                        `;
                    }

                    finalHtml += `<div class="bg-gray-800 p-4 rounded-lg shadow-md mb-4 fade-in">`;
                    finalHtml += `<div class="flex justify-between items-start mb-2"><div class="flex items-start"><p class="font-bold text-lg text-blue-400">${dateObj.toLocaleDateString('pt-BR')} - <span class="font-semibold">Local: ${auditoriumForDay}</span></p>${summaryHtml}</div><button class="px-3 py-1 bg-red-600 text-white rounded-md text-sm delete-event-btn no-print" data-id="${eventsOnDay[0].id}">Excluir Dia</button></div>`;
                    
                    eventsOnDay.forEach((event, index) => {
                        const alertCircuits = /SP-?0?26|SP-?0?28|crioulo/i;
                        const hasAlert = alertCircuits.test(event.circuitsList);
                        const alertClass = hasAlert ? 'bg-yellow-900/30 border-l-4 border-yellow-500 pl-3' : '';
                        
                        finalHtml += `<div class="py-2 ${alertClass}">`;
                        finalHtml += `<p class="text-gray-300"><span class="font-semibold">Responsável (Presidente):</span> <span class="editable-event" data-id="${event.id}" data-field="speakerName">${event.speakerName}</span></p>`;
                        finalHtml += `<p class="text-gray-300"><span class="font-semibold">Circuitos (${event.circuits}):</span> <span class="editable-event" data-id="${event.id}" data-field="circuitsList">${event.circuitsList}</span></p>`;
                        finalHtml += `<p class="text-gray-300"><span class="font-semibold">Nº Congs:</span> <span class="editable-event" data-id="${event.id}" data-field="congregations">${event.congregations}</span></p>`;
                        finalHtml += `<p class="text-gray-300"><span class="font-semibold">FDS Usados:</span> <span class="editable-event" data-id="${event.id}" data-field="weekends">${event.weekends}</span></p>`;
                        finalHtml += `<p class="text-gray-300"><span class="font-semibold">Pubs. Estimados:</span> <span class="editable-event" data-id="${event.id}" data-field="publishers">${event.publishers}</span></p>`;
                        finalHtml += `<p class="text-gray-300"><span class="font-semibold">Assist. Estimada:</span> <span class="editable-event" data-id="${event.id}" data-field="quantity">${event.quantity}</span></p>`;
                        
                        if (index < eventsOnDay.length - 1) {
                            finalHtml += `<hr class="my-2 border-gray-700">`;
                        }
                        finalHtml += `</div>`;
                    });
                    finalHtml += `</div>`;
                }
                containerElement.innerHTML = finalHtml;
            };

            renderEventList(filteredEvents, allEventsList);
            renderEventList(circuitEvents, circuitEventsList);
            renderEventList(bethelEvents, bethelEventsList);
            
            document.querySelectorAll('.delete-event-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idToDelete = parseFloat(e.target.dataset.id);
                    const eventToDelete = eventsData.find(ev => ev.id === idToDelete);
                    if (!eventToDelete) return;

                    const dateToDelete = eventToDelete.date;
                    const eventsOnDay = eventsData.filter(ev => ev.date === dateToDelete).length;

                    const message = eventsOnDay > 1 
                        ? `Tem certeza que deseja excluir todos os ${eventsOnDay} eventos do dia ${new Date(dateToDelete + 'T00:00:00').toLocaleDateString('pt-BR')}?`
                        : 'Tem certeza que deseja excluir este evento?';

                    showConfirmModal(message, (confirmed) => {
                        if (confirmed) {
                            eventsData = eventsData.filter(ev => ev.date !== dateToDelete);
                            renderEvents();
                            saveDataToLocalStorage();
                            showMessage('Evento(s) excluído(s).', 'success');
                        }
                    });
                });
            });
            document.querySelectorAll('.editable-event').forEach(span => {
                span.addEventListener('click', handleEventEdit);
            });
        }
        
        function populateEventFilters() {
            const yearButtonsContainer = D('eventFilterYearButtons');
            const monthButtonsContainer = D('eventFilterMonthButtons');
            yearButtonsContainer.innerHTML = '';
            monthButtonsContainer.innerHTML = '';

            const years = [...new Set(eventsData.map(e => new Date(e.date + "T00:00:00").getFullYear()))].sort((a, b) => a - b);
            
            const allYearBtn = document.createElement('button');
            allYearBtn.dataset.year = 'all';
            allYearBtn.textContent = 'Todos';
            allYearBtn.className = `px-3 py-1 text-sm rounded-md transition-colors ${eventFilterYear === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-600 hover:bg-gray-700'}`;
            allYearBtn.addEventListener('click', () => {
                eventFilterYear = 'all';
                renderEvents();
            });
            yearButtonsContainer.appendChild(allYearBtn);

            years.forEach(y => {
                const yearBtn = document.createElement('button');
                yearBtn.dataset.year = y;
                yearBtn.textContent = y;
                yearBtn.className = `px-3 py-1 text-sm rounded-md transition-colors ${eventFilterYear === y ? 'bg-blue-600 text-white' : 'bg-gray-600 hover:bg-gray-700'}`;
                yearBtn.addEventListener('click', () => {
                    eventFilterYear = y;
                    renderEvents();
                });
                yearButtonsContainer.appendChild(yearBtn);
            });

            const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            
            const allMonthBtn = document.createElement('button');
            allMonthBtn.dataset.month = '-1';
            allMonthBtn.textContent = 'Todos os Meses';
            allMonthBtn.className = `col-span-3 px-3 py-1 text-sm rounded-md transition-colors ${eventFilterMonth === -1 ? 'bg-blue-600 text-white' : 'bg-gray-600 hover:bg-gray-700'}`;
            allMonthBtn.addEventListener('click', () => {
                eventFilterMonth = -1;
                renderEvents();
            });
            monthButtonsContainer.appendChild(allMonthBtn);

            monthNames.forEach((m, i) => {
                const monthBtn = document.createElement('button');
                monthBtn.dataset.month = i;
                monthBtn.textContent = m;
                monthBtn.className = `px-3 py-1 text-sm rounded-md transition-colors ${eventFilterMonth === i ? 'bg-blue-600 text-white' : 'bg-gray-600 hover:bg-gray-700'}`;
                monthBtn.addEventListener('click', () => {
                    eventFilterMonth = i;
                    renderEvents();
                });
                monthButtonsContainer.appendChild(monthBtn);
            });
        }


        function showSummaryPopup() {
            const filteredEvents = eventsData.filter(e => {
                const eventDate = new Date(e.date + "T00:00:00");
                let yearMatch = false;
                if (eventFilterYear === 'all') {
                    yearMatch = eventDate.getFullYear() >= 2025;
                } else {
                    yearMatch = eventDate.getFullYear() === parseInt(eventFilterYear);
                }
                const monthMatch = eventFilterMonth === -1 || eventDate.getMonth() === eventFilterMonth;
                return yearMatch && monthMatch;
            });
            const circuitEvents = filteredEvents.filter(e => e.speakerType === 'circuit');
            const bethelEvents = filteredEvents.filter(e => e.speakerType === 'bethel');

            const calculateTotals = (eventList) => ({
                publishers: eventList.reduce((sum, e) => sum + (e.publishers || 0), 0),
                attendance: eventList.reduce((sum, e) => sum + (e.quantity || 0), 0),
                weekends: eventList.reduce((sum, e) => sum + (e.weekends || 0), 0),
                circuits: eventList.reduce((sum, e) => sum + (e.circuits || 0), 0),
                congregations: eventList.reduce((sum, e) => sum + (e.congregations || 0), 0)
            });

            const circuitTotals = calculateTotals(circuitEvents);
            const bethelTotals = calculateTotals(bethelEvents);
            const allTotals = calculateTotals(filteredEvents);

            D('summary-publishers-circuit').textContent = circuitTotals.publishers;
            D('summary-attendance-circuit').textContent = circuitTotals.attendance;
            D('summary-weekends-circuit').textContent = circuitTotals.weekends;
            D('summary-circuits-circuit').textContent = circuitTotals.circuits;
            D('summary-congregations-circuit').textContent = circuitTotals.congregations;
            
            D('summary-publishers-bethel').textContent = bethelTotals.publishers;
            D('summary-attendance-bethel').textContent = bethelTotals.attendance;
            D('summary-weekends-bethel').textContent = bethelTotals.weekends;
            D('summary-circuits-bethel').textContent = bethelTotals.circuits;
            D('summary-congregations-bethel').textContent = bethelTotals.congregations;

            D('summary-publishers-total').textContent = allTotals.publishers;
            D('summary-attendance-total').textContent = allTotals.attendance;
            D('summary-weekends-total').textContent = allTotals.weekends;
            D('summary-circuits-total').textContent = allTotals.circuits;
            D('summary-congregations-total').textContent = allTotals.congregations;
            
            const ctx = D('summaryChart').getContext('2d');
            if (summaryChartInstance) {
                summaryChartInstance.destroy();
            }
            summaryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Pub. Estimados', 'Assist. Estimada'],
                    datasets: [{
                        label: 'Sup. de Circuito',
                        data: [circuitTotals.publishers, circuitTotals.attendance],
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Rep. de Betel',
                        data: [bethelTotals.publishers, bethelTotals.attendance],
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#d1d5db' }
                        },
                        x: {
                            ticks: { color: '#d1d5db' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#d1d5db'
                            }
                        }
                    }
                }
            });

            summaryModal.classList.add('visible');
        }

        function clearAllData() {
            showConfirmModal('Tem certeza que deseja apagar TODOS os dados (pessoas, ocorrências e eventos)? Essa ação não pode ser desfeita.', (confirmed) => {
                if (confirmed) {
                    peopleData = [];
                    occurrencesData = [];
                    eventsData = [];
                    currentSchedule = [];
                    renderAll();
                    saveDataToLocalStorage();
                    showMessage('Todos os dados foram apagados com sucesso.', 'success');
                }
            });
        }

        function clearAllEvents() {
            showConfirmModal('Tem certeza que deseja apagar TODOS os eventos? Essa ação não pode ser desfeita.', (confirmed) => {
                if (confirmed) {
                    eventsData = [];
                    renderEvents();
                    saveDataToLocalStorage();
                    showMessage('Todos os eventos foram apagados.', 'success');
                }
            });
        }
        
        function loadEventsFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const header = json[0].map(h => h.toString().toLowerCase().trim());
                    const colIndex = {
                        event: header.indexOf('event'),
                        data: header.indexOf('data'),
                        circuitNumber: header.indexOf('circuit number'),
                        weekends: header.indexOf('fds usados'),
                        congregations: header.indexOf('qntd congs.'),
                        publishers: header.indexOf('pub. estimados'),
                        quantity: header.indexOf('assist. estimada')
                    };

                    if (Object.values(colIndex).some(index => index === -1)) {
                        showMessage('O cabeçalho da planilha é inválido. Verifique se as colunas esperadas existem.', 'error');
                        return;
                    }

                    let importedCount = 0;
                    json.slice(1).forEach(row => {
                        const circuit = row[colIndex.circuitNumber];
                        const eventName = row[colIndex.event];

                        if (!circuit || !eventName || circuit.toString().toLowerCase().includes('total') || eventName.toString().toLowerCase().includes('total')) {
                            return;
                        }

                        let date = row[colIndex.data];
                        if (!(date instanceof Date)) {
                            date = new Date(date);
                        }
                        if (isNaN(date.getTime())) {
                            console.warn("Skipping row with invalid date:", row);
                            return; 
                        }
                        const dateStr = flatpickr.formatDate(date, "Y-m-d");

                        const quantity = parseInt(row[colIndex.quantity]) || 0;
                        let speakerType = 'circuit'; 
                        if (eventName.toLowerCase().includes('representante')) {
                            speakerType = 'bethel';
                        }
                        
                        const newEvent = {
                            id: Date.now() + Math.random(),
                            date: dateStr,
                            name: 'Assembleia', 
                            publishers: parseInt(row[colIndex.publishers]) || 0,
                            quantity: quantity,
                            weekends: parseInt(row[colIndex.weekends]) || 1,
                            congregations: parseInt(row[colIndex.congregations]) || 0,
                            circuitsList: circuit.toString(),
                            circuits: circuit.toString().split(',').length,
                            speakerType: speakerType,
                            speakerName: `Orador de ${circuit}`
                        };
                        
                        eventsData.push(newEvent);
                        importedCount++;
                    });

                    if (importedCount > 0) {
                        renderEvents();
                        saveDataToLocalStorage();
                        showMessage(`${importedCount} eventos importados da planilha.`, 'success');
                    } else {
                        showMessage('Nenhum evento novo encontrado na planilha para importar.', 'info');
                    }

                } catch (error) {
                    console.error("Erro ao processar a planilha de eventos:", error);
                    showMessage('Ocorreu um erro ao ler a planilha.', 'error');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleEventEdit(event) {
            const span = event.target;
            if (span.querySelector('input') || span.querySelector('select')) return;
            const id = parseFloat(span.dataset.id); 
            const field = span.dataset.field;
            const eventToEdit = eventsData.find(e => e.id === id);
            if (!eventToEdit) return;
            const currentValue = eventToEdit[field];
            let inputElement;

            const createSelect = (options, selectedValue) => {
                const select = document.createElement('select');
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (opt.value === selectedValue) option.selected = true;
                    select.appendChild(option);
                });
                return select;
            };

            if (field === 'date') {
                inputElement = document.createElement('input');
                inputElement.type = 'date';
                inputElement.value = currentValue;
            } else if (field === 'name') {
                inputElement = createSelect([{ value: 'Assembleia', text: 'Assembleia' }, { value: 'Congresso', text: 'Congresso' }], currentValue);
            } else if (field === 'speakerName' || field === 'circuitsList') {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.value = currentValue;
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'number';
                inputElement.value = currentValue;
            }
            inputElement.className = 'w-full p-1 border border-blue-400 rounded-md';

            const saveChanges = () => {
                let newValue = inputElement.value;
                if (inputElement.type === 'number') newValue = parseInt(newValue) || 0;
                
                eventToEdit[field] = newValue;

                if (field === 'circuitsList') {
                    eventToEdit.circuits = newValue ? newValue.toString().split(',').length : 0;
                }
                
                saveDataToLocalStorage();
                renderEvents();
            };

            inputElement.addEventListener('blur', saveChanges);
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveChanges();
                if (e.key === 'Escape') renderEvents();
            });
            span.innerHTML = '';
            span.appendChild(inputElement);
            inputElement.focus();
        }

        function printSection(sectionClass) {
            let printStyles = D('print-styles');
            if (sectionClass === 'printing-schedule') {
                printStyles.innerHTML = `@page { size: landscape; margin: 1cm; }`;
            } else {
                printStyles.innerHTML = `@page { size: portrait; margin: 1.5cm; }`;
            }
            document.body.classList.add(sectionClass);
            window.print();
        }

        function exportDataToExcel() {
            if (peopleData.length === 0) {
                showMessage('Nenhum publicador para exportar.', 'info');
                return;
            }

            const displayMeetingDayWeekdayMap = { '': 'Nenhuma', 'segunda': 'Segunda-feira', 'terca': 'Terça-feira', 'quarta': 'Quarta-feira', 'quinta': 'Quinta-feira', 'sexta': 'Sexta-feira' };
            const displayMeetingDayWeekendMap = { '': 'Nenhuma', 'sabado': 'Sábado', 'domingo': 'Domingo', 'final de semana': 'Fim de Semana' };

            const dataToExport = peopleData.map(p => ({
                'Nome': p.name,
                'Gênero': p.gender,
                'Cônjuge': p.spouseName || '',
                'Reunião Semana': displayMeetingDayWeekdayMap[p.meetingDayWeekday] || 'N/A',
                'Reunião Fim de Semana': displayMeetingDayWeekendMap[p.meetingDayWeekend] || 'N/A',
                'Assembleia/Congresso': (p.congress || []).join(', '),
                'Seg': p.segunda ? 'Sim' : 'Não',
                'Ter': p.terca ? 'Sim' : 'Não',
                'Qua': p.quarta ? 'Sim' : 'Não',
                'Qui': p.quinta ? 'Sim' : 'Não',
                'Sex': p.sexta ? 'Sim' : 'Não',
                'Sab': p.sabado ? 'Sim' : 'Não',
                'Dom': p.domingo ? 'Sim' : 'Não'
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Publicadores");

            XLSX.writeFile(workbook, "publicadores.xlsx");
            showMessage('Dados exportados com sucesso!', 'success');
        }

        function exportEventsToExcel() {
            if (eventsData.length === 0) {
                showMessage('Nenhum evento para exportar.', 'info');
                return;
            }

            const dataToExport = eventsData.map(e => {
                const totalQuantityForDay = eventsData
                    .filter(ev => ev.date === e.date)
                    .reduce((sum, ev) => sum + ev.quantity, 0);

                let auditoriumForDay;
                if (totalQuantityForDay <= 50) {
                    auditoriumForDay = 'Auditório C';
                } else if (totalQuantityForDay > 500) {
                    auditoriumForDay = 'Auditório A';
                } else {
                    auditoriumForDay = 'Auditório B';
                }

                return {
                    'Data': new Date(e.date + 'T00:00:00').toLocaleDateString('pt-BR'),
                    'Nome do Evento': e.name,
                    'Tipo de Orador': e.speakerType === 'bethel' ? 'Representante de Betel' : 'Superintendente de Circuito',
                    'Nome do Orador': e.speakerName,
                    'Circuitos': e.circuitsList,
                    'Nº Circuitos': e.circuits,
                    'Nº Congregações': e.congregations,
                    'FDS Usados': e.weekends,
                    'Pubs. Estimados': e.publishers,
                    'Assist. Estimada': e.quantity,
                    'Auditório Designado': auditoriumForDay
                };
            }).sort((a, b) => new Date(a.Data.split('/').reverse().join('-')) - new Date(b.Data.split('/').reverse().join('-')));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Eventos");

            XLSX.writeFile(workbook, "eventos_atualizados.xlsx");
            showMessage('Planilha de eventos exportada com sucesso!', 'success');
        }


        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            congressDatePicker = flatpickr("#newCongressDates", { mode: "range", dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y", locale: "pt" });
            const sections = document.querySelectorAll('.content-section');
            const navLinks = { 'nav-info': infoSection, 'nav-schedule': scheduleSection, 'nav-occurrences': occurrencesSection, 'nav-events': eventsSection };

            function showSection(targetSection) {
                sectionLoadingScreen.classList.add('visible');
                if (targetSection === infoSection) mainTitle.textContent = 'Informações dos Publicadores';
                else if (targetSection === scheduleSection) mainTitle.textContent = 'Escala de Trabalho';
                else if (targetSection === occurrencesSection) mainTitle.textContent = 'Registro de Ocorrências';
                else if (targetSection === eventsSection) mainTitle.textContent = 'Organizador de Eventos';
                
                setTimeout(() => {
                    sections.forEach(s => s.classList.add('hidden'));
                    targetSection.classList.remove('hidden');
                    sectionLoadingScreen.classList.remove('visible');
                    sectionLoadingScreen.classList.add('hidden');
                }, 300);
            }

            Object.keys(navLinks).forEach(navId => D(navId).addEventListener('click', (e) => {
                e.preventDefault();
                showSection(navLinks[navId]);
                 if (document.body.classList.contains('menu-open') && window.innerWidth < 1024) {
                    document.body.classList.remove('menu-open');
                    sidebarOverlay.classList.add('hidden');
                    menuOpenIcon.classList.remove('hidden');
                    menuCloseIcon.classList.add('hidden');
                }
            }));

            setTimeout(async () => {
                loadingScreen.classList.add('hidden');
                showSection(infoSection);
                loadDataFromLocalStorage();
                populateScheduleControls();
            }, 1000);
            
            window.onafterprint = () => {
                document.body.className = 'group'; // Reset classes
                D('print-styles').innerHTML = '';
            };
            
            // Event Listeners for Buttons
            confirmModalYes.addEventListener('click', () => { if (confirmCallback) confirmCallback(true); confirmModal.classList.remove('visible'); });
            confirmModalNo.addEventListener('click', () => { if (confirmCallback) confirmCallback(false); confirmModal.classList.remove('visible'); });
            addPersonBtn.addEventListener('click', addPerson);
            deleteSelectedButton.addEventListener('click', deleteSelectedPeople);
            saveDataButton.addEventListener('click', saveDataToFile);
            loadDataButton.addEventListener('click', () => loadDataFileInput.click());
            loadDataFileInput.addEventListener('change', loadDataFromFile);
            exportExcelButton.addEventListener('click', exportDataToExcel);
            clearAllDataBtn.addEventListener('click', clearAllData);
            dataTableToggle.addEventListener('click', () => { dataTableContent.classList.toggle('hidden'); toggleIcon.textContent = dataTableContent.classList.contains('hidden') ? '►' : '▼'; });
            addPersonFormToggle.addEventListener('click', () => { addPersonFormContent.classList.toggle('hidden'); addPersonToggleIcon.textContent = addPersonFormContent.classList.contains('hidden') ? '►' : '▼'; });
            generateScheduleBtn.addEventListener('click', generateSchedule);
            printScheduleBtn.addEventListener('click', () => printSection('printing-schedule'));
            saveScheduleBtn.addEventListener('click', saveScheduleToFile);
            addOccurrenceBtn.addEventListener('click', addOccurrence);
            printOccurrencesBtn.addEventListener('click', () => printSection('printing-occurrences'));
            addEventBtn.addEventListener('click', addEvent);
            printEventsBtn.addEventListener('click', () => printSection('printing-events'));
            exportEventsExcelBtn.addEventListener('click', exportEventsToExcel);
            showSummaryBtn.addEventListener('click', showSummaryPopup);
            summaryModalClose.addEventListener('click', () => summaryModal.classList.remove('visible'));
            
            allTabBtn.addEventListener('click', () => { 
                allTabBtn.classList.add('active'); 
                circuitTabBtn.classList.remove('active'); 
                bethelTabBtn.classList.remove('active'); 
                allEventsList.classList.remove('hidden'); 
                circuitEventsList.classList.add('hidden'); 
                bethelEventsList.classList.add('hidden'); 
            });
            circuitTabBtn.addEventListener('click', () => { 
                allTabBtn.classList.remove('active'); 
                circuitTabBtn.classList.add('active'); 
                bethelTabBtn.classList.remove('active'); 
                allEventsList.classList.add('hidden'); 
                circuitEventsList.classList.remove('hidden'); 
                bethelEventsList.classList.add('hidden'); 
            });
            bethelTabBtn.addEventListener('click', () => { 
                allTabBtn.classList.remove('active'); 
                circuitTabBtn.classList.remove('active'); 
                bethelTabBtn.classList.add('active'); 
                allEventsList.classList.add('hidden'); 
                circuitEventsList.classList.add('hidden'); 
                bethelEventsList.classList.remove('hidden'); 
            });

            newEventSpeakerTypeSelect.addEventListener('change', (e) => { const selection = e.target.value; bethelSpeakerContainer.classList.toggle('hidden', selection !== 'bethel'); circuitSpeakerContainer.classList.toggle('hidden', selection !== 'circuit'); });
            newStatusSelect.addEventListener('change', (e) => { if (e.target.value === 'Casal') coupleContainer.classList.remove('hidden'); else { coupleContainer.classList.add('hidden'); newSpouseNameInput.value = ''; } });
            menuToggle.addEventListener('click', () => { document.body.classList.toggle('menu-open'); menuOpenIcon.classList.toggle('hidden'); menuCloseIcon.classList.toggle('hidden'); if (window.innerWidth < 1024) sidebarOverlay.classList.toggle('hidden', !document.body.classList.contains('menu-open')); });
            sidebarOverlay.addEventListener('click', () => { document.body.classList.remove('menu-open'); sidebarOverlay.classList.add('hidden'); menuOpenIcon.classList.remove('hidden'); menuCloseIcon.classList.add('hidden'); });
            if (window.innerWidth >= 1024) { document.body.classList.add('menu-open'); menuOpenIcon.classList.add('hidden'); menuCloseIcon.classList.remove('hidden'); }
            filterYearSelect.addEventListener('change', (e) => { currentFilterYear = parseInt(e.target.value); renderOccurrences(); });
            eventFormToggle.addEventListener('click', () => { eventFormContent.classList.toggle('hidden'); eventToggleIcon.textContent = eventFormContent.classList.contains('hidden') ? '►' : '▼'; });
            loadEventsExcelBtn.addEventListener('click', () => eventsExcelFileInput.click());
            eventsExcelFileInput.addEventListener('change', loadEventsFromExcel);
            clearAllEventsBtn.addEventListener('click', clearAllEvents);
        });
    </script>
</body>

</html>
