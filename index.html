<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Pessoas, Escalas e Ocorrências</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
    <!-- XLSX Library CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Flatpickr Date Picker CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr Portuguese Locale -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            line-height: 1.6;
        }
        /* New styles for the main title */
        h1.main-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            color: #1e3a8a; /* Darker blue */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Loading Screen Styles */
        #loading-screen, #section-loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f4f8; display: flex; justify-content: center;
            align-items: center; z-index: 9999; transition: opacity 0.5s ease-out;
        }
        #loading-screen.hidden, #section-loading-screen.hidden {
            opacity: 0; pointer-events: none;
        }
        #section-loading-screen { z-index: 9998; opacity: 0; }
        #section-loading-screen.visible { opacity: 1; pointer-events: auto; }
        .pulsing-image { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        /* Custom File Input */
        .file-input::-webkit-file-upload-button {
            margin-right: 1rem; padding: 0.5rem 1rem; border-radius: 9999px;
            border: 0; font-size: 0.875rem; font-weight: 600;
            background-color: #eff6ff; color: #1d4ed8; cursor: pointer;
        }
        .file-input:hover::-webkit-file-upload-button { background-color: #dbeafe; }
        /* Table Cell Styles */
        .data-table .day-cell, .data-table .editable-text-cell { cursor: pointer; }
        .data-table .day-cell { text-align: center; }
        
        /* New Data Table Styles */
        .data-table thead th {
            background-color: #2c5282; /* A nice darker blue */
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .data-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #edf2f7; /* A light gray */
        }
        .data-table tbody tr:hover {
            background-color: #bee3f8; /* A light blue on hover */
        }

        /* New Schedule Table Styles */
        .schedule-table thead th {
            background-color: #1e3a8a; /* Dark blue */
            color: white;
            font-weight: 600;
        }
        .schedule-table .weekend-day {
            background-color: #f3f4f6; /* gray-100 */
        }
        .schedule-table .attendant-cell {
            background-color: #e0f2fe; /* sky-100 */
        }
        .schedule-table .watchman-cell {
            background-color: #dcfce7; /* green-100 */
        }
        .schedule-table .editable-schedule-cell { 
            cursor: pointer; 
            transition: background-color 0.2s ease-in-out;
        }
        .schedule-table .editable-schedule-cell:hover { 
            background-color: #bfdbfe; /* blue-200 for hover */
        }
        
        /* Collapsible Section */
        .collapsible-header {
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; padding: 1rem; background-color: #e2e8f0;
            border-radius: 0.5rem; font-weight: 600; color: #475569;
            margin-bottom: 1rem; transition: background-color 0.3s ease-in-out;
        }
        .collapsible-header:hover { background-color: #d1d5db; }
        .collapsible-content { display: block; transition: all 0.3s ease-in-out; }
        .collapsible-content.hidden { display: none; opacity: 0; max-height: 0; overflow: hidden; }
        
        /* Custom Modal for Confirmations */
        #custom-confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex;
            justify-content: center; align-items: center; z-index: 10000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #custom-confirm-modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;
            max-width: 90%; width: 400px;
        }

        /* Print Styles */
        @media print {
            body {
                background-color: #fff !important;
                font-size: 11pt;
            }
            main {
                margin-left: 0 !important;
                padding: 1rem !important;
            }
            .no-print {
                display: none !important;
            }
            .content-section {
                display: none !important;
            }
            body.printing-schedule #schedule-section,
            body.printing-occurrences #occurrences-section {
                display: block !important;
            }
            .p-6.bg-white {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }
            h1.main-title, h2, h3 {
                text-align: center;
                color: #000;
                text-shadow: none;
            }

            /* Specific styles for printing the schedule */
            body.printing-schedule .schedule-table {
                width: 100%;
                border-collapse: collapse;
            }
            body.printing-schedule .schedule-table th,
            body.printing-schedule .schedule-table td {
                border: 1px solid #666;
                padding: 8px;
                color: #000;
                background-color: #fff !important;
            }
            body.printing-schedule .schedule-table thead th {
                background-color: #e5e7eb !important; /* gray-200 */
                color: #000;
            }
            
            /* Specific styles for printing occurrences */
            body.printing-occurrences #occurrences-list .bg-white {
                border: 1px solid #ccc;
                box-shadow: none;
                page-break-inside: avoid;
            }
            body.printing-occurrences img {
                display: none; /* Hide images for cleaner print */
            }
        }
    </style>
</head>
<body class="group">
    <!-- Loading Screen (Initial Page Load) -->
    <div id="loading-screen">
        <img src="images/colete.png" alt="Carregando..." class="pulsing-image w-32 h-32">
    </div>

    <!-- Section Loading Screen (for transitions between sections) -->
    <div id="section-loading-screen" class="hidden">
        <img src="images/colete.png" alt="Carregando..." class="pulsing-image w-32 h-32">
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal">
        <div class="modal-content">
            <p id="confirm-modal-text" class="mb-6 text-lg text-gray-700"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-yes" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">Sim</button>
                <button id="confirm-modal-no" class="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400">Não</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

    <!-- Vertical Sidebar Navigation -->
    <nav id="navbar" class="fixed top-0 left-0 h-full w-60 bg-blue-900 text-white shadow-xl z-30 flex flex-col items-center py-8 no-print transform -translate-x-full group-[.menu-open]:translate-x-0 transition-transform duration-300 ease-in-out">
        <!-- Logo at the top -->
        <div class="mb-10">
            <img src="images/logo.png" alt="Logo" class="h-12">
        </div>
        <!-- Navigation Links -->
        <div class="flex flex-col space-y-4 w-full px-4">
            <a href="#info-section" id="nav-info" class="text-lg font-semibold hover:bg-blue-700 p-3 rounded-lg transition-colors text-center">Informações</a>
            <a href="#schedule-section" id="nav-schedule" class="text-lg font-semibold hover:bg-blue-700 p-3 rounded-lg transition-colors text-center">Escala</a>
            <a href="#occurrences-section" id="nav-occurrences" class="text-lg font-semibold hover:bg-blue-700 p-3 rounded-lg transition-colors text-center">Ocorrências</a>
        </div>
    </nav>

    <!-- Menu Toggle Button -->
    <button id="menu-toggle" class="fixed top-4 left-4 z-40 p-2 bg-blue-800 text-white rounded-md hover:bg-blue-700 transition-all duration-300 ease-in-out no-print lg:group-[.menu-open]:left-64">
        <svg id="menu-open-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        <svg id="menu-close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>

    <!-- Main Content Area -->
    <main id="main-content" class="p-4 sm:p-6 lg:p-8 transition-all duration-300 ease-in-out lg:group-[.menu-open]:ml-60">
        <div class="max-w-7xl mx-auto">
            <!-- Title with new class for styling -->
            <h1 id="main-title" class="main-title text-4xl sm:text-5xl font-extrabold mb-8 text-center">
                Gerenciador Organizacional
            </h1>

            <!-- Info Section -->
            <div id="info-section" class="content-section hidden">
                <div class="mb-8 p-6 bg-white rounded-lg shadow-md no-print">
                    <div class="flex flex-col items-center gap-4">
                        <input type="file" id="excelFile" accept=".xlsx, .xls" class="file-input block w-full max-w-sm text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 w-full">
                            <button id="loadExcel" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 w-full">Carregar Planilha</button>
                            <button id="saveData" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 w-full">Salvar Dados</button>
                            <button id="loadData" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 w-full">Carregar Dados</button>
                            <button id="exportExcel" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 w-full">Exportar p/ Excel</button>
                            <button id="deleteSelectedBtn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 w-full">Excluir</button>
                            <button id="clearAllDataBtn" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 w-full">Limpar Tudo</button>
                        </div>
                    </div>
                </div>

                <!-- Add New Person Form -->
                <div class="mb-8 p-6 bg-white rounded-lg shadow-md no-print">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Adicionar Nova Pessoa</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="newName" placeholder="Nome Completo" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="newMeetingDayWeekday" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Reunião Meio de Semana</option>
                            <option value="segunda">Segunda-feira</option>
                            <option value="terca">Terça-feira</option>
                            <option value="quarta">Quarta-feira</option>
                            <option value="quinta">Quinta-feira</option>
                            <option value="sexta">Sexta-feira</option>
                        </select>
                        <select id="newMeetingDayWeekend" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Reunião Fim de Semana</option>
                            <option value="sabado">Sábado</option>
                            <option value="domingo">Domingo</option>
                            <option value="final de semana">Fim de Semana (Ambos)</option>
                        </select>
                    </div>
                    <!-- New Status and Spouse Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="newStatus" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="newStatus" class="p-2 border border-gray-300 rounded-md w-full">
                                <option value="Solteiro(a)">Solteiro(a)</option>
                                <option value="Casal">Casal</option>
                            </select>
                        </div>
                        <div id="spouse-name-container" class="hidden">
                             <label for="newSpouseName" class="block text-sm font-medium text-gray-700">Nome do Cônjuge</label>
                            <input type="text" id="newSpouseName" placeholder="Nome do Cônjuge" class="p-2 border border-gray-300 rounded-md w-full">
                        </div>
                    </div>
                    <!-- Congress Date Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dias do Congresso (Selecione um período):</label>
                        <input type="text" id="newCongressDates" placeholder="Clique para selecionar o início e o fim..." readonly class="p-2 border border-gray-300 rounded-md w-full cursor-pointer bg-white">
                    </div>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <label class="flex items-center space-x-2"><input type="checkbox" id="newSeg" class="form-checkbox" checked><span>Seg</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="newTer" class="form-checkbox" checked><span>Ter</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="newQua" class="form-checkbox" checked><span>Qua</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="newQui" class="form-checkbox" checked><span>Qui</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="newSex" class="form-checkbox" checked><span>Sex</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="newSab" class="form-checkbox" checked><span>Sab</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" id="newDom" class="form-checkbox" checked><span>Dom</span></label>
                    </div>
                    <button id="addPersonBtn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 w-full transform hover:scale-105">Adicionar Pessoa</button>
                </div>
                <div id="message-box" class="hidden p-4 mb-4 text-sm text-center rounded-lg no-print" role="alert"></div>

                <!-- Collapsible Data Table Section -->
                <div class="mb-8">
                    <div id="dataTableToggle" class="collapsible-header no-print">
                        <span>Publicadores</span>
                        <span id="toggleIcon">▼</span>
                    </div>
                    <div id="dataTableContent" class="collapsible-content">
                        <div id="data-container" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Schedule Generator Section -->
            <div id="schedule-section" class="content-section hidden">
                <div class="mb-8 p-6 bg-white rounded-lg shadow-md">
                    <div class="no-print">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Gerador de Escala de Trabalho</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="scheduleMonth" class="block text-sm font-medium text-gray-700">Mês:</label>
                                <select id="scheduleMonth" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                            </div>
                            <div>
                                <label for="scheduleYear" class="block text-sm font-medium text-gray-700">Ano:</label>
                                <input type="number" id="scheduleYear" value="2025" min="2024" max="2050" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="scheduleCouplesTogether" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <label for="scheduleCouplesTogether" class="ml-2 text-sm font-medium text-gray-700">Agrupar casais na mesma escala?</label>
                        </div>
                        <div class="flex gap-4">
                            <button id="generateScheduleBtn" class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transform hover:scale-105">Gerar Escala</button>
                            <button id="printScheduleBtn" class="flex-1 px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transform hover:scale-105 hidden">Imprimir Escala</button>
                        </div>
                    </div>
                    <div id="schedule-output" class="mt-6 overflow-x-auto"></div>
                </div>
            </div>
            
            <!-- Occurrences Section -->
            <div id="occurrences-section" class="content-section hidden">
                <div class="flex flex-col md:flex-row-reverse gap-6">
                    <!-- Filter Sidebar -->
                    <aside id="occurrence-filters" class="w-full md:w-64 flex-shrink-0 bg-white p-4 rounded-lg shadow-md no-print self-start">
                        <h3 class="font-semibold text-lg mb-4 text-gray-700">Filtrar Ocorrências</h3>
                        <div>
                            <label for="filterYear" class="block text-sm font-medium text-gray-600">Ano</label>
                            <select id="filterYear" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-600">Mês</label>
                            <div id="filterMonth" class="mt-1 space-y-1">
                                <!-- Months will be populated by JS -->
                            </div>
                        </div>
                    </aside>

                    <!-- Main Occurrences Area (Form + List) -->
                    <div class="flex-grow">
                        <div class="mb-8 p-6 bg-white rounded-lg shadow-md no-print">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-semibold text-gray-800">Registro de Ocorrências</h2>
                                <button id="printOccurrencesBtn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transform hover:scale-105">Imprimir Ocorrências</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="occurrenceDate" class="block text-sm font-medium text-gray-700">Data da Ocorrência:</label>
                                    <input type="date" id="occurrenceDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="occurrencePeople" class="block text-sm font-medium text-gray-700">No turno:</label>
                                    <select id="occurrencePeople" multiple class="mt-1 block w-full p-2 border border-gray-300 rounded-md h-32"></select>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="occurrenceImages" class="block text-sm font-medium text-gray-700">Imagens da Ocorrência:</label>
                                <input type="file" id="occurrenceImages" multiple accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                            <div class="mb-4">
                                <label for="occurrenceDescription" class="block text-sm font-medium text-gray-700">Descrição:</label>
                                <textarea id="occurrenceDescription" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Descreva o que aconteceu..."></textarea>
                            </div>
                            <button id="addOccurrenceBtn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 w-full transform hover:scale-105">Salvar Ocorrência</button>
                        </div>
                         <div id="occurrences-list" class="mt-6">
                            <!-- Occurrences will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Global Variables ---
        var peopleData = [];
        var occurrencesData = [];
        let currentSchedule = []; // To hold the generated schedule data for editing
        let congressDatePicker; // To hold the flatpickr instance
        let currentFilterYear = new Date().getFullYear();
        let currentFilterMonth = new Date().getMonth();

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const sectionLoadingScreen = document.getElementById('section-loading-screen');
        const mainTitle = document.getElementById('main-title');
        const navInfo = document.getElementById('nav-info');
        const navSchedule = document.getElementById('nav-schedule');
        const navOccurrences = document.getElementById('nav-occurrences');
        const infoSection = document.getElementById('info-section');
        const scheduleSection = document.getElementById('schedule-section');
        const occurrencesSection = document.getElementById('occurrences-section');
        const excelFileInput = document.getElementById('excelFile');
        const loadExcelButton = document.getElementById('loadExcel');
        const saveDataButton = document.getElementById('saveData');
        const loadDataButton = document.getElementById('loadData');
        const exportExcelButton = document.getElementById('exportExcel');
        const deleteSelectedButton = document.getElementById('deleteSelectedBtn');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const dataContainer = document.getElementById('data-container');
        const messageBox = document.getElementById('message-box');
        const newNameInput = document.getElementById('newName');
        const newMeetingDayWeekdaySelect = document.getElementById('newMeetingDayWeekday');
        const newMeetingDayWeekendSelect = document.getElementById('newMeetingDayWeekend');
        const newStatusSelect = document.getElementById('newStatus');
        const spouseNameContainer = document.getElementById('spouse-name-container');
        const newSpouseNameInput = document.getElementById('newSpouseName');
        const newCongressDatesInput = document.getElementById('newCongressDates');
        const newSegCheckbox = document.getElementById('newSeg');
        const newTerCheckbox = document.getElementById('newTer');
        const newQuaCheckbox = document.getElementById('newQua');
        const newQuiCheckbox = document.getElementById('newQui');
        const newSexCheckbox = document.getElementById('newSex');
        const newSabCheckbox = document.getElementById('newSab');
        const newDomCheckbox = document.getElementById('newDom');
        const addPersonBtn = document.getElementById('addPersonBtn');
        const scheduleMonthSelect = document.getElementById('scheduleMonth');
        const scheduleYearInput = document.getElementById('scheduleYear');
        const scheduleCouplesTogetherCheckbox = document.getElementById('scheduleCouplesTogether');
        const generateScheduleBtn = document.getElementById('generateScheduleBtn');
        const printScheduleBtn = document.getElementById('printScheduleBtn');
        const scheduleOutputDiv = document.getElementById('schedule-output');
        const occurrenceDateInput = document.getElementById('occurrenceDate');
        const occurrencePeopleSelect = document.getElementById('occurrencePeople');
        const occurrenceImagesInput = document.getElementById('occurrenceImages');
        const occurrenceDescriptionInput = document.getElementById('occurrenceDescription');
        const addOccurrenceBtn = document.getElementById('addOccurrenceBtn');
        const printOccurrencesBtn = document.getElementById('printOccurrencesBtn');
        const occurrencesListDiv = document.getElementById('occurrences-list');
        const dataTableToggle = document.getElementById('dataTableToggle');
        const dataTableContent = document.getElementById('dataTableContent');
        const toggleIcon = document.getElementById('toggleIcon');
        const loadDataFileInput = document.createElement('input');
        loadDataFileInput.type = 'file';
        loadDataFileInput.accept = '.json';
        loadDataFileInput.style.display = 'none';
        document.body.appendChild(loadDataFileInput);
        const confirmModal = document.getElementById('custom-confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalYes = document.getElementById('confirm-modal-yes');
        const confirmModalNo = document.getElementById('confirm-modal-no');
        let confirmCallback = null;
        // Responsive Menu Elements
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('navbar');
        const mainContent = document.getElementById('main-content');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuOpenIcon = document.getElementById('menu-open-icon');
        const menuCloseIcon = document.getElementById('menu-close-icon');
        // Occurrence Filter Elements
        const filterYearSelect = document.getElementById('filterYear');
        const filterMonthDiv = document.getElementById('filterMonth');


        // --- Utility & Core Functions ---
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'p-4 mb-4 text-sm text-center rounded-lg no-print'; // Reset classes
            messageBox.classList.remove('hidden');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        function showConfirmModal(message, callback) {
            confirmModalText.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.add('visible');
        }
        
        confirmModalYes.addEventListener('click', () => {
            if (confirmCallback) confirmCallback(true);
            confirmModal.classList.remove('visible');
        });

        confirmModalNo.addEventListener('click', () => {
            if (confirmCallback) confirmCallback(false);
            confirmModal.classList.remove('visible');
        });

        function saveDataToLocalStorage() {
            try {
                const appData = {
                    people: peopleData,
                    occurrences: occurrencesData
                };
                localStorage.setItem('organizationalAppData', JSON.stringify(appData));
            } catch (error) {
                console.error('Erro ao salvar dados no localStorage:', error);
                showMessage('Erro ao salvar dados localmente.', 'error');
            }
        }

        function loadDataFromLocalStorage() {
            try {
                const storedData = localStorage.getItem('organizationalAppData');
                if (storedData) {
                    const appData = JSON.parse(storedData);
                    peopleData = appData.people || [];
                    occurrencesData = appData.occurrences || [];
                    renderAll();
                    showMessage('Dados carregados com sucesso!', 'success');
                } else {
                    showMessage('Nenhum dado salvo localmente encontrado.', 'info');
                }
            } catch (error) {
                console.error('Erro ao carregar dados do localStorage:', error);
                showMessage('Erro ao carregar dados locais.', 'error');
            }
        }

        // --- NEW COMMENT: This function saves all data to a file on your computer.
        // It opens your file manager so you can choose where to save it.
        function saveDataToFile() {
            if (peopleData.length === 0 && occurrencesData.length === 0) {
                showMessage('Não há dados para salvar.', 'info');
                return;
            }
            try {
                const appData = {
                    people: peopleData,
                    occurrences: occurrencesData
                };
                const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'banco_de_dados_organizacional.json';
                a.click(); // This line triggers the browser's "Save As..." dialog
                URL.revokeObjectURL(url);
                showMessage('Dados salvos em "banco_de_dados_organizacional.json"!', 'success');
            } catch (error) {
                console.error('Erro ao salvar dados no arquivo:', error);
                showMessage('Erro ao salvar dados no arquivo.', 'error');
            }
        }

        // --- NEW COMMENT: This function loads data from a file you select on your computer.
        // The "Carregar Dados" button triggers this process.
        function loadDataFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const appData = JSON.parse(e.target.result);
                    if (typeof appData === 'object' && appData !== null) {
                        peopleData = appData.people || [];
                        occurrencesData = appData.occurrences || [];
                        renderAll();
                        showMessage('Dados carregados do arquivo com sucesso!', 'success');
                        saveDataToLocalStorage();
                    } else {
                        showMessage('Formato de arquivo inválido.', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao ler o arquivo de dados:', error);
                    showMessage('Erro ao processar o arquivo de dados.', 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function renderAll() {
            renderData();
            populateOccurrencePeopleSelect();
            renderOccurrences();
            scheduleOutputDiv.innerHTML = ''; // Clear schedule on data change
            printScheduleBtn.classList.add('hidden');
        }

        // --- Render People Data Table ---
        function renderData() {
            dataContainer.innerHTML = '';
            if (peopleData.length === 0) {
                dataContainer.innerHTML = '<p class="text-center text-gray-600 col-span-full">Nenhum dado para exibir.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full border-collapse mt-6 bg-white rounded-lg overflow-hidden shadow-md data-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="p-4 text-left border-b"><input type="checkbox" id="selectAllCheckbox" class="form-checkbox"></th>
                        <th class="p-4 text-left border-b">Nome</th>
                        <th class="p-4 text-left border-b">Status</th>
                        <th class="p-4 text-left border-b">Cônjuge</th>
                        <th class="p-4 text-left border-b">Reunião Semana</th>
                        <th class="p-4 text-left border-b">Reunião Fim Semana</th>
                        <th class="p-4 text-left border-b">Congresso</th>
                        <th class="p-4 text-center border-b">Seg</th>
                        <th class="p-4 text-center border-b">Ter</th>
                        <th class="p-4 text-center border-b">Qua</th>
                        <th class="p-4 text-center border-b">Qui</th>
                        <th class="p-4 text-center border-b">Sex</th>
                        <th class="p-4 text-center border-b">Sab</th>
                        <th class="p-4 text-center border-b">Dom</th>
                        <th class="p-4 text-left border-b">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>`;
            
            const tbody = table.querySelector('tbody');
            const daysOfWeekMapping = { "Seg": 'segunda', "Ter": 'terca', "Qua": 'quarta', "Qui": 'quinta', "Sex": 'sexta', "Sab": 'sabado', "Dom": 'domingo' };
            const daysOrder = Object.keys(daysOfWeekMapping);

            peopleData.forEach((person, index) => {
                const tr = tbody.insertRow();
                
                const displayMeetingDayWeekdayMap = { '': 'Nenhuma', 'segunda': 'Segunda-feira', 'terca': 'Terça-feira', 'quarta': 'Quarta-feira', 'quinta': 'Quinta-feira', 'sexta': 'Sexta-feira' };
                const displayMeetingDayWeekendMap = { '': 'Nenhuma', 'sabado': 'Sábado', 'domingo': 'Domingo', 'final de semana': 'Fim de Semana' };
                
                const formattedCongressDates = (person.congress || [])
                    .map(dateStr => {
                        // Handles both YYYY-MM-DD and potentially other formats if data is old
                        const date = new Date(dateStr + 'T00:00:00');
                        return isNaN(date) ? dateStr : date.toLocaleDateString('pt-BR');
                    })
                    .join(', ');

                let cells = `
                    <td class="p-4 border-b"><input type="checkbox" class="row-checkbox form-checkbox" data-index="${index}"></td>
                    <td class="p-4 border-b editable-text-cell" data-field="name" data-index="${index}">${person.name || 'N/A'}</td>
                    <td class="p-4 border-b editable-text-cell" data-field="status" data-index="${index}">${person.status || 'N/A'}</td>
                    <td class="p-4 border-b editable-text-cell" data-field="spouseName" data-index="${index}">${person.spouseName || ''}</td>
                    <td class="p-4 border-b editable-text-cell" data-field="meetingDayWeekday" data-index="${index}">${displayMeetingDayWeekdayMap[person.meetingDayWeekday] || 'N/A'}</td>
                    <td class="p-4 border-b editable-text-cell" data-field="meetingDayWeekend" data-index="${index}">${displayMeetingDayWeekendMap[person.meetingDayWeekend] || 'N/A'}</td>
                    <td class="p-4 border-b editable-text-cell" data-field="congress" data-index="${index}">${formattedCongressDates || 'N/A'}</td>
                `;

                daysOrder.forEach(dayDisplay => {
                    const dayKey = daysOfWeekMapping[dayDisplay];
                    const isAvailable = person[dayKey];
                    cells += `<td class="p-4 border-b day-cell" data-field="${dayKey}" data-index="${index}" style="color: ${isAvailable ? '#16a34a' : '#dc2626'}; font-weight: bold;">${isAvailable ? '✓' : '✗'}</td>`;
                });

                cells += `<td class="p-4 border-b"><button class="px-3 py-1 bg-red-500 text-white rounded-md text-sm delete-person-btn" data-index="${index}">Excluir</button></td>`;
                tr.innerHTML = cells;
            });
            
            dataContainer.appendChild(table);
            addTableEventListeners();
        }
        
        function addTableEventListeners() {
            document.querySelectorAll('.editable-text-cell').forEach(cell => cell.addEventListener('click', handleTextCellEdit));
            document.querySelectorAll('.day-cell').forEach(cell => cell.addEventListener('click', handleDayCellToggle));
            document.getElementById('selectAllCheckbox')?.addEventListener('change', handleSelectAll);
            document.querySelectorAll('.row-checkbox').forEach(checkbox => checkbox.addEventListener('change', handleRowCheckboxChange));
            document.querySelectorAll('.delete-person-btn').forEach(btn => btn.addEventListener('click', (e) => deletePerson(parseInt(e.target.dataset.index))));
        }

        // --- People CRUD & Table Interactions ---
        function addPerson() {
            const name = newNameInput.value.trim();
            if (!name) {
                showMessage('O nome é obrigatório.', 'error');
                return;
            }
            const status = newStatusSelect.value;
            const spouseName = (status === 'Casal') ? newSpouseNameInput.value.trim() : '';
            if (status === 'Casal' && !spouseName) {
                showMessage('O nome do cônjuge é obrigatório para o status "Casal".', 'error');
                return;
            }

            let congressDates = [];
            if (congressDatePicker.selectedDates.length > 0) {
                const start = congressDatePicker.selectedDates[0];
                const end = congressDatePicker.selectedDates.length > 1 ? congressDatePicker.selectedDates[1] : start;
                let currentDate = new Date(start);
                while (currentDate <= end) {
                    congressDates.push(flatpickr.formatDate(currentDate, "Y-m-d"));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            const commonData = {
                meetingDayWeekday: newMeetingDayWeekdaySelect.value,
                meetingDayWeekend: newMeetingDayWeekendSelect.value,
                congress: congressDates,
                segunda: newSegCheckbox.checked, terca: newTerCheckbox.checked,
                quarta: newQuaCheckbox.checked, quinta: newQuiCheckbox.checked,
                sexta: newSexCheckbox.checked, sabado: newSabCheckbox.checked,
                domingo: newDomCheckbox.checked
            };

            const person1 = {
                ...commonData,
                name: name,
                status: status,
                spouseName: spouseName,
            };
            peopleData.push(person1);

            if (status === 'Casal') {
                const person2 = {
                    ...commonData,
                    name: spouseName,
                    status: status,
                    spouseName: name,
                };
                peopleData.push(person2);
            }
            
            renderAll();
            saveDataToLocalStorage();
            showMessage('Pessoa(s) adicionada(s) com sucesso!', 'success');
            
            // Clear form
            newNameInput.value = '';
            newStatusSelect.value = 'Solteiro(a)';
            newSpouseNameInput.value = '';
            spouseNameContainer.classList.add('hidden');
            newMeetingDayWeekdaySelect.value = '';
            newMeetingDayWeekendSelect.value = '';
            congressDatePicker.clear();
            [newSegCheckbox, newTerCheckbox, newQuaCheckbox, newQuiCheckbox, newSexCheckbox, newSabCheckbox, newDomCheckbox].forEach(cb => cb.checked = true);
        }

        function deletePerson(index) {
            showConfirmModal('Tem certeza que deseja excluir esta pessoa?', (confirmed) => {
                if (confirmed) {
                    peopleData.splice(index, 1);
                    renderAll();
                    saveDataToLocalStorage();
                    showMessage('Pessoa excluída com sucesso!', 'success');
                }
            });
        }
        
        function deleteSelectedPeople() {
            const selectedIndices = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.dataset.index));
            if (selectedIndices.length === 0) {
                showMessage('Nenhuma pessoa selecionada.', 'info');
                return;
            }
            showConfirmModal(`Tem certeza que deseja excluir ${selectedIndices.length} pessoa(s)?`, (confirmed) => {
                if (confirmed) {
                    selectedIndices.sort((a, b) => b - a).forEach(index => peopleData.splice(index, 1));
                    renderAll();
                    saveDataToLocalStorage();
                    showMessage(`${selectedIndices.length} pessoa(s) excluída(s)!`, 'success');
                }
            });
        }
        
        function handleSelectAll(event) {
            document.querySelectorAll('.row-checkbox').forEach(checkbox => checkbox.checked = event.target.checked);
        }

        function handleRowCheckboxChange() {
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            const selectAll = document.getElementById('selectAllCheckbox');
            if(selectAll) {
               selectAll.checked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
            }
        }

        function handleDayCellToggle(event) {
            const cell = event.target;
            const index = parseInt(cell.dataset.index);
            const field = cell.dataset.field;
            peopleData[index][field] = !peopleData[index][field];
            renderData();
            saveDataToLocalStorage();
        }

        function handleTextCellEdit(event) {
            const cell = event.target;
            const index = parseInt(cell.dataset.index);
            const field = cell.dataset.field;

            if (cell.querySelector('input') || cell.querySelector('select')) return;

            const currentValue = peopleData[index][field];
            let inputElement;

            const createSelect = (options, selectedValue) => {
                const select = document.createElement('select');
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    if (opt.value === selectedValue) option.selected = true;
                    select.appendChild(option);
                });
                return select;
            };

            if (field === 'status') {
                inputElement = createSelect([
                    { value: 'Solteiro(a)', text: 'Solteiro(a)' },
                    { value: 'Casal', text: 'Casal' }
                ], currentValue);
            } else if (field === 'congress') {
                const tempInput = document.createElement('input');
                tempInput.type = 'hidden';
                cell.appendChild(tempInput);
                const defaultDate = (Array.isArray(currentValue) && currentValue.length > 0)
                    ? [currentValue[0], currentValue[currentValue.length - 1]]
                    : [];

                const picker = flatpickr(tempInput, {
                    mode: "range",
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "d/m/Y",
                    defaultDate: defaultDate,
                    locale: "pt",
                    onClose: function(selectedDates) {
                        let newCongressDates = [];
                        if (selectedDates.length === 2) {
                            const [start, end] = selectedDates;
                            let currentDate = new Date(start);
                            while (currentDate <= end) {
                                newCongressDates.push(flatpickr.formatDate(currentDate, "Y-m-d"));
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                        } else if (selectedDates.length === 1) {
                            newCongressDates.push(flatpickr.formatDate(selectedDates[0], "Y-m-d"));
                        }
                        peopleData[index][field] = newCongressDates;
                        renderData();
                        saveDataToLocalStorage();
                    },
                    appendTo: cell
                });
                picker.open();
                return;
            } else if (field === 'meetingDayWeekday') {
                inputElement = createSelect([
                    { value: '', text: 'Nenhuma' }, { value: 'segunda', text: 'Segunda-feira' },
                    { value: 'terca', text: 'Terça-feira' }, { value: 'quarta', text: 'Quarta-feira' },
                    { value: 'quinta', text: 'Quinta-feira' }, { value: 'sexta', text: 'Sexta-feira' }
                ], currentValue);
            } else if (field === 'meetingDayWeekend') {
                inputElement = createSelect([
                    { value: '', text: 'Nenhuma' }, { value: 'sabado', text: 'Sábado' },
                    { value: 'domingo', text: 'Domingo' }, { value: 'final de semana', text: 'Fim de Semana' }
                ], currentValue);
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.value = currentValue || '';
            }

            inputElement.className = 'w-full p-1 border border-blue-400 rounded-md focus:outline-none';
            
            const saveChanges = () => {
                peopleData[index][field] = inputElement.value.trim();
                renderData();
                saveDataToLocalStorage();
            };

            inputElement.addEventListener('blur', saveChanges);
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') inputElement.blur();
                else if (e.key === 'Escape') renderData();
            });

            cell.innerHTML = '';
            cell.appendChild(inputElement);
            inputElement.focus();
        }

        // --- Excel Import/Export ---
        loadExcelButton.addEventListener('click', () => {
            const file = excelFileInput.files[0];
            if (!file) {
                showMessage('Por favor, selecione um arquivo Excel primeiro.', 'info');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (json.length < 2) {
                        showMessage('A planilha está vazia ou não tem cabeçalhos.', 'error');
                        return;
                    }

                    const headers = json[0].map(h => String(h || '').toLowerCase().trim());
                    const dataRows = json.slice(1);

                    const getIndex = (keys) => {
                        for (const key of keys) {
                            const index = headers.indexOf(key);
                            if (index !== -1) return index;
                        }
                        return -1;
                    };

                    const nameIndex = getIndex(['nome', 'primeiro nome']);
                    const meetingWeekIndex = getIndex(['dia reunião semana', 'reunião semana']);
                    const meetingWeekendIndex = getIndex(['dia reunião fim de semana', 'reunião fim de semana']);
                    const congress1Index = getIndex(['congresso1', 'congresso 1']);
                    const congress2Index = getIndex(['congresso2', 'congresso 2']);
                    const congress3Index = getIndex(['congresso3', 'congresso 3']);
                    const dayIndexes = {
                        segunda: getIndex(['seg']), terca: getIndex(['ter']), quarta: getIndex(['qua']),
                        quinta: getIndex(['qui']), sexta: getIndex(['sex']), sabado: getIndex(['sab']), domingo: getIndex(['dom'])
                    };

                    peopleData = dataRows.map(row => {
                        const congressDates = [
                            row[congress1Index], row[congress2Index], row[congress3Index]
                        ].filter(Boolean).map(d => String(d));

                        const person = {
                            name: row[nameIndex] || '',
                            phone: '',
                            meetingDayWeekday: String(row[meetingWeekIndex] || '').toLowerCase().trim(),
                            meetingDayWeekend: String(row[meetingWeekendIndex] || '').toLowerCase().trim(),
                            congress: congressDates,
                            segunda: row[dayIndexes.segunda] ? true : false,
                            terca: row[dayIndexes.terca] ? true : false,
                            quarta: row[dayIndexes.quarta] ? true : false,
                            quinta: row[dayIndexes.quinta] ? true : false,
                            sexta: row[dayIndexes.sexta] ? true : false,
                            sabado: row[dayIndexes.sabado] ? true : false,
                            domingo: row[dayIndexes.domingo] ? true : false
                        };
                        return person;
                    }).filter(p => p.name);

                    renderAll();
                    saveDataToLocalStorage();
                    showMessage('Dados da planilha carregados com sucesso!', 'success');

                } catch (error) {
                    console.error('Erro ao ler o arquivo Excel:', error);
                    showMessage('Erro ao processar o arquivo Excel.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        exportExcelButton.addEventListener('click', () => {
            if (peopleData.length === 0 && occurrencesData.length === 0 && currentSchedule.length === 0) {
                showMessage('Não há dados para exportar.', 'info');
                return;
            }

            const wb = XLSX.utils.book_new();

            // --- People Data Sheet ---
            if (peopleData.length > 0) {
                const exportPeople = peopleData.map(p => ({
                    'Nome': p.name,
                    'Status': p.status,
                    'Cônjuge': p.spouseName,
                    'Reunião Semana': p.meetingDayWeekday,
                    'Reunião Fim de Semana': p.meetingDayWeekend,
                    'Congresso': (p.congress || []).join(', '),
                    'Seg': p.segunda ? 'x' : '', 'Ter': p.terca ? 'x' : '', 'Qua': p.quarta ? 'x' : '',
                    'Qui': p.quinta ? 'x' : '', 'Sex': p.sexta ? 'x' : '', 'Sab': p.sabado ? 'x' : '', 'Dom': p.domingo ? 'x' : ''
                }));
                const wsPeople = XLSX.utils.json_to_sheet(exportPeople);
                wsPeople['!cols'] = [
                    { wch: 30 }, { wch: 15 }, { wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 30 },
                    { wch: 5 }, { wch: 5 }, { wch: 5 }, { wch: 5 },
                    { wch: 5 }, { wch: 5 }, { wch: 5 }
                ];
                XLSX.utils.book_append_sheet(wb, wsPeople, "Dados de Pessoas");
            }

            // --- Schedule Sheet ---
            if (currentSchedule.length > 0) {
                const exportSchedule = currentSchedule.map(entry => ({
                    'Data': new Date(entry.date + 'T00:00:00').toLocaleDateString('pt-BR'),
                    'Dia da Semana': entry.dayOfWeek.charAt(0).toUpperCase() + entry.dayOfWeek.slice(1),
                    'Atendente': entry.attendant,
                    'Vigia': entry.watchman
                }));
                const wsSchedule = XLSX.utils.json_to_sheet(exportSchedule);
                wsSchedule['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 30 }, { wch: 30 }];
                XLSX.utils.book_append_sheet(wb, wsSchedule, "Escala de Trabalho");
            }

            // --- Occurrences Sheet ---
            if (occurrencesData.length > 0) {
                const exportOccurrences = occurrencesData.map(o => ({
                    'Data': new Date(o.date + 'T00:00:00').toLocaleDateString('pt-BR'),
                    'Pessoas Envolvidas': o.people.join(', '),
                    'Descrição': o.description
                }));
                const wsOccurrences = XLSX.utils.json_to_sheet(exportOccurrences);
                wsOccurrences['!cols'] = [{ wch: 15 }, { wch: 40 }, { wch: 80 }];
                XLSX.utils.book_append_sheet(wb, wsOccurrences, "Ocorrências");
            }

            XLSX.writeFile(wb, "dados_organizacionais.xlsx");
            showMessage('Dados exportados para "dados_organizacionais.xlsx"!', 'success');
        });

        // --- Occurrences Logic ---
        function populateOccurrencePeopleSelect() {
            occurrencePeopleSelect.innerHTML = '';
            peopleData.forEach(person => {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                occurrencePeopleSelect.appendChild(option);
            });
        }

        async function addOccurrence() {
            const date = occurrenceDateInput.value;
            const description = occurrenceDescriptionInput.value.trim();
            const selectedPeople = Array.from(occurrencePeopleSelect.selectedOptions).map(opt => opt.value);
            const files = occurrenceImagesInput.files;

            if (!date || !description || selectedPeople.length === 0) {
                showMessage('Por favor, preencha todos os campos da ocorrência.', 'error');
                return;
            }

            const images = await readFilesAsDataURLs(files);

            occurrencesData.push({ 
                id: Date.now(), 
                date: date, 
                people: selectedPeople, 
                description: description,
                images: images 
            });
            renderOccurrences();
            saveDataToLocalStorage();
            showMessage('Ocorrência registrada com sucesso!', 'success');
            
            // Clear form
            occurrenceDateInput.value = '';
            occurrenceDescriptionInput.value = '';
            occurrencePeopleSelect.selectedIndex = -1;
            occurrenceImagesInput.value = '';
        }

        function readFilesAsDataURLs(files) {
            return Promise.all(Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }));
        }

        function renderOccurrences() {
            populateOccurrenceFilters();
            const filteredOccurrences = occurrencesData.filter(o => {
                const occurrenceDate = new Date(o.date + "T00:00:00");
                const yearMatch = occurrenceDate.getFullYear() === currentFilterYear;
                const monthMatch = currentFilterMonth === -1 || occurrenceDate.getMonth() === currentFilterMonth;
                return yearMatch && monthMatch;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            occurrencesListDiv.innerHTML = '<h3 class="text-xl font-semibold text-gray-800 mb-4">Ocorrências Registradas</h3>';
            if (filteredOccurrences.length === 0) {
                occurrencesListDiv.innerHTML += '<p class="text-gray-600">Nenhuma ocorrência encontrada para este período.</p>';
                return;
            }

            filteredOccurrences.forEach(o => {
                const occurrenceEl = document.createElement('div');
                occurrenceEl.className = 'bg-white p-4 rounded-lg shadow-md mb-4';

                let imagesHtml = '';
                if (o.images && o.images.length > 0) {
                    imagesHtml += '<div class="flex flex-wrap gap-2 mb-2">';
                    o.images.forEach(imgData => {
                        imagesHtml += `<img src="${imgData}" class="w-32 h-32 object-cover rounded-md border">`;
                    });
                    imagesHtml += '</div>';
                }

                occurrenceEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg text-blue-700">${new Date(o.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                            ${imagesHtml}
                            <p class="font-semibold text-gray-700 mt-1">No turno: ${o.people.join(', ')}</p>
                            <p class="text-gray-600 mt-2">${o.description.replace(/\n/g, '<br>')}</p>
                        </div>
                        <button class="px-3 py-1 bg-red-500 text-white rounded-md text-sm delete-occurrence-btn no-print" data-id="${o.id}">Excluir</button>
                    </div>`;
                occurrencesListDiv.appendChild(occurrenceEl);
            });
            document.querySelectorAll('.delete-occurrence-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idToDelete = parseInt(e.target.dataset.id);
                     showConfirmModal('Tem certeza que deseja excluir esta ocorrência?', (confirmed) => {
                        if(confirmed) {
                            occurrencesData = occurrencesData.filter(o => o.id !== idToDelete);
                            renderOccurrences();
                            saveDataToLocalStorage();
                            showMessage('Ocorrência excluída.', 'success');
                        }
                    });
                });
            });
        }

        function populateOccurrenceFilters() {
            const years = [...new Set(occurrencesData.map(o => new Date(o.date + "T00:00:00").getFullYear()))].sort((a, b) => b - a);
            filterYearSelect.innerHTML = years.map(y => `<option value="${y}" ${y === currentFilterYear ? 'selected' : ''}>${y}</option>`).join('');

            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            let monthsHtml = `<a href="#" data-month="-1" class="block p-2 rounded-md text-sm ${currentFilterMonth === -1 ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}">Todos os Meses</a>`;
            monthsHtml += monthNames.map((m, i) => `<a href="#" data-month="${i}" class="block p-2 rounded-md text-sm ${i === currentFilterMonth ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}">${m}</a>`).join('');
            filterMonthDiv.innerHTML = monthsHtml;

            filterMonthDiv.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentFilterMonth = parseInt(e.target.dataset.month);
                    renderOccurrences();
                });
            });
        }

        // --- Schedule Generator Logic ---
        const dayNamesShort = ["domingo", "segunda", "terca", "quarta", "quinta", "sexta", "sabado"];

        function populateScheduleControls() {
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            scheduleMonthSelect.innerHTML = monthNames.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            scheduleMonthSelect.value = new Date().getMonth();
            scheduleYearInput.value = new Date().getFullYear();
        }

        function generateSchedule() {
            if (peopleData.length === 0) {
                showMessage('Não há pessoas cadastradas para gerar a escala.', 'error');
                return;
            }
            const month = parseInt(scheduleMonthSelect.value);
            const year = parseInt(scheduleYearInput.value);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const groupCouples = scheduleCouplesTogetherCheckbox.checked;
            
            const workCount = peopleData.reduce((acc, person) => ({ ...acc, [person.name]: 0 }), {});
            currentSchedule = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayName = dayNamesShort[date.getDay()];
                const formattedDate = flatpickr.formatDate(date, "Y-m-d");

                let availablePeople = peopleData.filter(person => {
                    let isAvailable = person[dayName];
                    if (isAvailable && Array.isArray(person.congress) && person.congress.includes(formattedDate)) isAvailable = false;
                    if (isAvailable && person.meetingDayWeekday === dayName) isAvailable = false;
                    if (isAvailable && (person.meetingDayWeekend === dayName || (person.meetingDayWeekend === 'final de semana' && (dayName === 'sabado' || dayName === 'domingo')))) isAvailable = false;
                    return isAvailable;
                });

                let pool = [...availablePeople].sort((a, b) => workCount[a.name] - workCount[b.name]);
                let attendant = 'VAGO';
                let watchman = 'VAGO';
                let assignedNames = [];

                // Assign Attendant
                if (pool.length > 0) {
                    const person1 = pool.shift();
                    if (groupCouples && person1.status === 'Casal') {
                        const spouseIndex = pool.findIndex(p => p.name === person1.spouseName);
                        if (spouseIndex !== -1) {
                            const spouse = pool.splice(spouseIndex, 1)[0];
                            attendant = `${person1.name} e ${spouse.name}`;
                            watchman = attendant; // Assign couple to both roles
                            assignedNames.push(person1.name, spouse.name);
                        } else {
                            attendant = person1.name; // Assign as single if spouse not available
                            assignedNames.push(person1.name);
                        }
                    } else {
                        attendant = person1.name;
                        assignedNames.push(person1.name);
                    }
                }

                // Assign Watchman if not already filled by a couple
                if (watchman === 'VAGO' && pool.length > 0) {
                    const person2 = pool.shift();
                    watchman = person2.name;
                    assignedNames.push(person2.name);
                }

                // Update work counts
                assignedNames.forEach(name => {
                    if (workCount.hasOwnProperty(name)) {
                        workCount[name]++;
                    }
                });

                currentSchedule.push({ date: formattedDate, dayOfWeek: dayName, attendant, watchman });
            }
            
            renderScheduleTable();
            showMessage('Escala gerada com sucesso!', 'success');
            printScheduleBtn.classList.remove('hidden');
        }

        function renderScheduleTable() {
            const month = parseInt(scheduleMonthSelect.value);
            const year = parseInt(scheduleYearInput.value);
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

            let scheduleHtml = `
                <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Escala de Trabalho - ${monthNames[month]} de ${year}</h3>
                <table class="w-full border-collapse bg-white rounded-lg shadow-md data-table schedule-table">
                    <thead><tr>
                        <th class="p-4 text-left border-b">Data</th>
                        <th class="p-4 text-left border-b">Dia da Semana</th>
                        <th class="p-4 text-left border-b">Atendente</th>
                        <th class="p-4 text-left border-b">Vigia</th>
                    </tr></thead><tbody>`;
            
            currentSchedule.forEach((entry, index) => {
                const dateObj = new Date(entry.date + 'T00:00:00');
                const isWeekend = entry.dayOfWeek === 'sabado' || entry.dayOfWeek === 'domingo';
                const rowClass = isWeekend ? 'weekend-day' : '';
                
                scheduleHtml += `
                    <tr class="${rowClass}">
                        <td class="p-4 border-b">${dateObj.toLocaleDateString('pt-BR')}</td>
                        <td class="p-4 border-b capitalize">${entry.dayOfWeek}</td>
                        <td class="p-4 border-b editable-schedule-cell attendant-cell" data-day-index="${index}" data-role="attendant">${entry.attendant}</td>
                        <td class="p-4 border-b editable-schedule-cell watchman-cell" data-day-index="${index}" data-role="watchman">${entry.watchman}</td>
                    </tr>`;
            });
            scheduleHtml += `</tbody></table>`;
            scheduleOutputDiv.innerHTML = scheduleHtml;

            // Add event listeners for editing
            document.querySelectorAll('.editable-schedule-cell').forEach(cell => {
                cell.addEventListener('click', handleScheduleEdit);
            });
        }
        
        function handleScheduleEdit(event) {
            const cell = event.target;
            const dayIndex = parseInt(cell.dataset.dayIndex);
            const role = cell.dataset.role;
            const scheduleEntry = currentSchedule[dayIndex];
            
            // Find who is available on this day
            const availablePeople = peopleData.filter(person => {
                let isAvailable = person[scheduleEntry.dayOfWeek];
                if (isAvailable && Array.isArray(person.congress) && person.congress.includes(scheduleEntry.date)) isAvailable = false;
                if (isAvailable && person.meetingDayWeekday === scheduleEntry.dayOfWeek) isAvailable = false;
                if (isAvailable && (person.meetingDayWeekend === scheduleEntry.dayOfWeek || (person.meetingDayWeekend === 'final de semana' && (scheduleEntry.dayOfWeek === 'sabado' || scheduleEntry.dayOfWeek === 'domingo')))) isAvailable = false;
                return isAvailable;
            });

            // Exclude the person already assigned to the other role
            const otherRole = role === 'attendant' ? 'watchman' : 'attendant';
            const otherPersonName = scheduleEntry[otherRole];
            // Also exclude the spouse of the other person if they are a couple
            const otherPersonObject = peopleData.find(p => p.name === otherPersonName);
            const otherSpouseName = otherPersonObject ? otherPersonObject.spouseName : null;

            const finalOptions = availablePeople.filter(p => p.name !== otherPersonName && p.name !== otherSpouseName);

            // Create select dropdown
            const select = document.createElement('select');
            select.className = 'w-full p-1 border border-blue-400 rounded-md';
            
            let optionsHtml = `<option value="${cell.textContent}">${cell.textContent}</option>`;
            if (cell.textContent !== 'VAGO') {
                 optionsHtml += `<option value="VAGO">-- VAGO --</option>`;
            }
            
            finalOptions.forEach(p => {
                if (p.name !== cell.textContent) {
                    optionsHtml += `<option value="${p.name}">${p.name}</option>`;
                }
            });
            select.innerHTML = optionsHtml;

            cell.innerHTML = '';
            cell.appendChild(select);
            select.focus();

            const saveChange = () => {
                scheduleEntry[role] = select.value;
                renderScheduleTable(); // Re-render the table to reflect change
            };

            select.addEventListener('blur', saveChange);
            select.addEventListener('change', saveChange);
        }

        // --- New Functions ---
        function clearAllData() {
            showConfirmModal('Tem certeza que deseja apagar TODOS os dados (pessoas, ocorrências e escala)? Essa ação não pode ser desfeita.', (confirmed) => {
                if (confirmed) {
                    peopleData = [];
                    occurrencesData = [];
                    currentSchedule = [];
                    renderAll();
                    saveDataToLocalStorage();
                    showMessage('Todos os dados foram apagados com sucesso.', 'success');
                }
            });
        }

        function printSection(sectionClass) {
            document.body.classList.add(sectionClass);
            window.print();
        }

        // --- Page Navigation & Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Flatpickr for congress dates
            congressDatePicker = flatpickr("#newCongressDates", {
                mode: "range",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d/m/Y",
                locale: "pt",
            });

            const sections = document.querySelectorAll('.content-section');
            const navLinks = { 'nav-info': infoSection, 'nav-schedule': scheduleSection, 'nav-occurrences': occurrencesSection };
            
            function showSection(targetSection) {
                sectionLoadingScreen.classList.add('visible');
                
                // Update main title based on section
                if (targetSection === infoSection) {
                    mainTitle.textContent = 'Informações';
                } else if (targetSection === scheduleSection) {
                    mainTitle.textContent = 'Escala de Trabalho';
                } else if (targetSection === occurrencesSection) {
                    mainTitle.textContent = 'Registro de Ocorrências';
                }

                setTimeout(() => {
                    sections.forEach(s => s.classList.add('hidden'));
                    targetSection.classList.remove('hidden');
                    sectionLoadingScreen.classList.remove('visible');
                    sectionLoadingScreen.classList.add('hidden');
                }, 300);
            }

            Object.keys(navLinks).forEach(navId => {
                document.getElementById(navId).addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(navLinks[navId]);
                });
            });

            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                showSection(infoSection);
                loadDataFromLocalStorage();
                populateScheduleControls();
            }, 1500);

            // Clean up print classes after printing
            window.onafterprint = () => {
                document.body.classList.remove('printing-schedule', 'printing-occurrences');
            };

            const dayCheckboxes = {
                segunda: newSegCheckbox, terca: newTerCheckbox, quarta: newQuaCheckbox,
                quinta: newQuiCheckbox, sexta: newSexCheckbox, sabado: newSabCheckbox,
                domingo: newDomCheckbox
            };

            function updateAvailability() {
                Object.values(dayCheckboxes).forEach(cb => cb.checked = true);
                const weekdayMeeting = newMeetingDayWeekdaySelect.value;
                const weekendMeeting = newMeetingDayWeekendSelect.value;
                if (weekdayMeeting && dayCheckboxes[weekdayMeeting]) {
                    dayCheckboxes[weekdayMeeting].checked = false;
                }
                if (weekendMeeting) {
                    if (weekendMeeting === 'final de semana') {
                        dayCheckboxes.sabado.checked = false;
                        dayCheckboxes.domingo.checked = false;
                    } else if (dayCheckboxes[weekendMeeting]) {
                        dayCheckboxes[weekendMeeting].checked = false;
                    }
                }
            }

            // Event Listeners
            addPersonBtn.addEventListener('click', addPerson);
            deleteSelectedButton.addEventListener('click', deleteSelectedPeople);
            saveDataButton.addEventListener('click', saveDataToFile);
            loadDataButton.addEventListener('click', () => loadDataFileInput.click());
            loadDataFileInput.addEventListener('change', loadDataFromFile);
            clearAllDataBtn.addEventListener('click', clearAllData);
            dataTableToggle.addEventListener('click', () => {
                dataTableContent.classList.toggle('hidden');
                toggleIcon.textContent = dataTableContent.classList.contains('hidden') ? '►' : '▼';
            });
            generateScheduleBtn.addEventListener('click', generateSchedule);
            printScheduleBtn.addEventListener('click', () => printSection('printing-schedule'));
            addOccurrenceBtn.addEventListener('click', addOccurrence);
            printOccurrencesBtn.addEventListener('click', () => printSection('printing-occurrences'));
            
            newMeetingDayWeekdaySelect.addEventListener('change', updateAvailability);
            newMeetingDayWeekendSelect.addEventListener('change', updateAvailability);

            // Show/hide spouse name field based on status
            newStatusSelect.addEventListener('change', (e) => {
                if (e.target.value === 'Casal') {
                    spouseNameContainer.classList.remove('hidden');
                } else {
                    spouseNameContainer.classList.add('hidden');
                    newSpouseNameInput.value = '';
                }
            });

            // Responsive menu toggle logic
            menuToggle.addEventListener('click', () => {
                document.body.classList.toggle('menu-open');
                menuOpenIcon.classList.toggle('hidden');
                menuCloseIcon.classList.toggle('hidden');
                if (window.innerWidth < 1024) {
                    sidebarOverlay.classList.toggle('hidden', !document.body.classList.contains('menu-open'));
                }
            });
            
            sidebarOverlay.addEventListener('click', () => {
                 document.body.classList.remove('menu-open');
                 sidebarOverlay.classList.add('hidden');
                 menuOpenIcon.classList.remove('hidden');
                 menuCloseIcon.classList.add('hidden');
            });

            // Set initial menu state on load
            if (window.innerWidth >= 1024) {
                document.body.classList.add('menu-open');
                menuOpenIcon.classList.add('hidden');
                menuCloseIcon.classList.remove('hidden');
            }
            
            filterYearSelect.addEventListener('change', (e) => {
                currentFilterYear = parseInt(e.target.value);
                renderOccurrences();
            });

        });
    </script>
</body>
</html>
